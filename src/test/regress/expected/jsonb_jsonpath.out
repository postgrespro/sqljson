select _jsonpath_exists(jsonb '{"a": 12}', '$.a.b');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '{"a": 12}', '$.b');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '{"a": {"a": 12}}', '$.a.a');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"a": {"a": 12}}', '$.*.a');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"b": {"a": 12}}', '$.*.a');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{}', '$.*');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '{"a": 1}', '$.*');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"a": {"b": 1}}', '$.**{1}');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"a": {"b": 1}}', '$.**{2}');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"a": {"b": 1}}', '$.**{3}');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '[]', '$.[*]');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '[1]', '$.[*]');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '[1]', '$.[1]');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '[1]', '$.[0]');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"a": [1,2,3], "b": [3,4,5]}', '$ ? (@.a[*] >  @.b[*])');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '{"a": [1,2,3], "b": [3,4,5]}', '$ ? (@.a[*] >= @.b[*])');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"a": [1,2,3], "b": [3,4,"5"]}', '$ ? (@.a[*] >= @.b[*])');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '{"a": [1,2,3], "b": [3,4,null]}', '$ ? (@.a[*] >= @.b[*])');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '1', '$ ? ((@ == "1") is unknown)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '1', '$ ? ((@ == 1) is unknown)');
 _jsonpath_exists 
------------------
 f
(1 row)

select * from _jsonpath_query(jsonb '{"a": 12, "b": {"a": 13}}', '$.a');
 _jsonpath_query 
-----------------
 12
(1 row)

select * from _jsonpath_query(jsonb '{"a": 12, "b": {"a": 13}}', '$.b');
 _jsonpath_query 
-----------------
 {"a": 13}
(1 row)

select * from _jsonpath_query(jsonb '{"a": 12, "b": {"a": 13}}', '$.*');
 _jsonpath_query 
-----------------
 12
 {"a": 13}
(2 rows)

select * from _jsonpath_query(jsonb '{"a": 12, "b": {"a": 13}}', '$.*.a');
 _jsonpath_query 
-----------------
 13
(1 row)

select * from _jsonpath_query(jsonb '[12, {"a": 13}, {"b": 14}]', '$.[*].a');
 _jsonpath_query 
-----------------
 13
(1 row)

select * from _jsonpath_query(jsonb '[12, {"a": 13}, {"b": 14}]', '$.[*].*');
 _jsonpath_query 
-----------------
 13
 14
(2 rows)

select * from _jsonpath_query(jsonb '[12, {"a": 13}, {"b": 14}]', '$.[0].a');
 _jsonpath_query 
-----------------
(0 rows)

select * from _jsonpath_query(jsonb '[12, {"a": 13}, {"b": 14}]', '$.[1].a');
 _jsonpath_query 
-----------------
 13
(1 row)

select * from _jsonpath_query(jsonb '[12, {"a": 13}, {"b": 14}]', '$.[2].a');
 _jsonpath_query 
-----------------
(0 rows)

select * from _jsonpath_query(jsonb '[12, {"a": 13}, {"b": 14}]', '$.[0,1].a');
 _jsonpath_query 
-----------------
 13
(1 row)

select * from _jsonpath_query(jsonb '[12, {"a": 13}, {"b": 14}]', '$.[0 to 10].a');
 _jsonpath_query 
-----------------
 13
(1 row)

select * from _jsonpath_query(jsonb '{"a": 10}', '$');
 _jsonpath_query 
-----------------
 {"a": 10}
(1 row)

select * from _jsonpath_query(jsonb '{"a": 10}', '$ ? (.a < $value)');
ERROR:  could not find jsonpath variable 'value'
select * from _jsonpath_query(jsonb '{"a": 10}', '$ ? (.a < $value)', '{"value" : 13}');
 _jsonpath_query 
-----------------
 {"a": 10}
(1 row)

select * from _jsonpath_query(jsonb '{"a": 10}', '$ ? (.a < $value)', '{"value" : 8}');
 _jsonpath_query 
-----------------
(0 rows)

select * from _jsonpath_query(jsonb '{"a": 10}', '$.a ? (@ < $value)', '{"value" : 13}');
 _jsonpath_query 
-----------------
 10
(1 row)

select * from _jsonpath_query(jsonb '[10,11,12,13,14,15]', '$.[*] ? (@ < $value)', '{"value" : 13}');
 _jsonpath_query 
-----------------
 10
 11
 12
(3 rows)

select * from _jsonpath_query(jsonb '[10,11,12,13,14,15]', '$.[0,1] ? (@ < $value)', '{"value" : 13}');
 _jsonpath_query 
-----------------
 10
 11
(2 rows)

select * from _jsonpath_query(jsonb '[10,11,12,13,14,15]', '$.[0 to 2] ? (@ < $value)', '{"value" : 15}');
 _jsonpath_query 
-----------------
 10
 11
 12
(3 rows)

select * from _jsonpath_query(jsonb '[1,"1",2,"2",null]', '$.[*] ? (@ == "1")');
 _jsonpath_query 
-----------------
 "1"
(1 row)

select * from _jsonpath_query(jsonb '[1,"1",2,"2",null]', '$.[*] ? (@ == $value)', '{"value" : "1"}');
 _jsonpath_query 
-----------------
 "1"
(1 row)

select * from _jsonpath_query(jsonb '[1, "2", null]', '$[*] ? (@ != null)');
 _jsonpath_query 
-----------------
 1
 "2"
(2 rows)

select * from _jsonpath_query(jsonb '[1, "2", null]', '$[*] ? (@ == null)');
 _jsonpath_query 
-----------------
 null
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', '$.**');
 _jsonpath_query 
-----------------
 {"a": {"b": 1}}
 {"b": 1}
 1
(3 rows)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', '$.**{1}');
 _jsonpath_query 
-----------------
 {"b": 1}
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', '$.**{1,}');
 _jsonpath_query 
-----------------
 {"b": 1}
 1
(2 rows)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', '$.**{2}');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', '$.**{2,}');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', '$.**{3,}');
 _jsonpath_query 
-----------------
(0 rows)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', '$.**.b ? (@ > 0)');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', '$.**{0}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
(0 rows)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', '$.**{1}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', '$.**{0,}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', '$.**{1,}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', '$.**{1,2}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"c": {"b": 1}}}', '$.**.b ? (@ > 0)');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"c": {"b": 1}}}', '$.**{0}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
(0 rows)

select * from _jsonpath_query(jsonb '{"a": {"c": {"b": 1}}}', '$.**{1}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
(0 rows)

select * from _jsonpath_query(jsonb '{"a": {"c": {"b": 1}}}', '$.**{0,}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"c": {"b": 1}}}', '$.**{1,}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"c": {"b": 1}}}', '$.**{1,2}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"c": {"b": 1}}}', '$.**{2,3}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"b": 1}}', '$.**.b ? (@ > 0)');
 _jsonpath_exists 
------------------
 t
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"b": 1}}', '$.**{0}.b ? (@ > 0)');
 _jsonpath_exists 
------------------
 f
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"b": 1}}', '$.**{1}.b ? (@ > 0)');
 _jsonpath_exists 
------------------
 t
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"b": 1}}', '$.**{0,}.b ? (@ > 0)');
 _jsonpath_exists 
------------------
 t
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"b": 1}}', '$.**{1,}.b ? (@ > 0)');
 _jsonpath_exists 
------------------
 t
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"b": 1}}', '$.**{1,2}.b ? (@ > 0)');
 _jsonpath_exists 
------------------
 t
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"c": {"b": 1}}}', '$.**.b ? (@ > 0)');
 _jsonpath_exists 
------------------
 t
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"c": {"b": 1}}}', '$.**{0}.b ? (@ > 0)');
 _jsonpath_exists 
------------------
 f
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"c": {"b": 1}}}', '$.**{1}.b ? (@ > 0)');
 _jsonpath_exists 
------------------
 f
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"c": {"b": 1}}}', '$.**{0,}.b ? (@ > 0)');
 _jsonpath_exists 
------------------
 t
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"c": {"b": 1}}}', '$.**{1,}.b ? (@ > 0)');
 _jsonpath_exists 
------------------
 t
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"c": {"b": 1}}}', '$.**{1,2}.b ? (@ > 0)');
 _jsonpath_exists 
------------------
 t
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"c": {"b": 1}}}', '$.**{2,3}.b ? (@ > 0)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_query(jsonb '{"g": {"x": 2}}', '$.g ? (exists (@.x))');
 _jsonpath_query 
-----------------
 {"x": 2}
(1 row)

select _jsonpath_query(jsonb '{"g": {"x": 2}}', '$.g ? (exists (@.y))');
 _jsonpath_query 
-----------------
(0 rows)

select _jsonpath_query(jsonb '{"g": {"x": 2}}', '$.g ? (exists (@.x ? (@ >= 2) ))');
 _jsonpath_query 
-----------------
 {"x": 2}
(1 row)

--test ternary logic
select
	x, y,
	_jsonpath_query(
		jsonb '[true, false, null]',
		'$[*] ? (@ == true  &&  ($x == true && $y == true) ||
				 @ == false && !($x == true && $y == true) ||
				 @ == null  &&  ($x == true && $y == true) is unknown)',
		jsonb_build_object('x', x, 'y', y)
	) as "x && y"
from
	(values (jsonb 'true'), ('false'), ('"null"')) x(x),
	(values (jsonb 'true'), ('false'), ('"null"')) y(y);
   x    |   y    | x && y 
--------+--------+--------
 true   | true   | true
 true   | false  | false
 true   | "null" | null
 false  | true   | false
 false  | false  | false
 false  | "null" | false
 "null" | true   | null
 "null" | false  | false
 "null" | "null" | null
(9 rows)

select
	x, y,
	_jsonpath_query(
		jsonb '[true, false, null]',
		'$[*] ? (@ == true  &&  ($x == true || $y == true) ||
				 @ == false && !($x == true || $y == true) ||
				 @ == null  &&  ($x == true || $y == true) is unknown)',
		jsonb_build_object('x', x, 'y', y)
	) as "x || y"
from
	(values (jsonb 'true'), ('false'), ('"null"')) x(x),
	(values (jsonb 'true'), ('false'), ('"null"')) y(y);
   x    |   y    | x || y 
--------+--------+--------
 true   | true   | true
 true   | false  | true
 true   | "null" | true
 false  | true   | true
 false  | false  | false
 false  | "null" | null
 "null" | true   | true
 "null" | false  | null
 "null" | "null" | null
(9 rows)

select _jsonpath_exists(jsonb '{"a": 1, "b":1}', '$ ? (.a == .b)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"c": {"a": 1, "b":1}}', '$ ? (.a == .b)');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '{"c": {"a": 1, "b":1}}', '$.c ? (.a == .b)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"c": {"a": 1, "b":1}}', '$.* ? (.a == .b)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"a": 1, "b":1}', '$.** ? (.a == .b)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"c": {"a": 1, "b":1}}', '$.** ? (.a == .b)');
 _jsonpath_exists 
------------------
 t
(1 row)

