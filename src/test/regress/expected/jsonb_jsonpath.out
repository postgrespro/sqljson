select _jsonpath_exists(jsonb '{"a": 12}', '$.a.b');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '{"a": 12}', '$.b');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '{"a": {"a": 12}}', '$.a.a');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"a": {"a": 12}}', '$.*.a');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"b": {"a": 12}}', '$.*.a');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{}', '$.*');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '{"a": 1}', '$.*');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"a": {"b": 1}}', 'lax $.**{1}');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"a": {"b": 1}}', 'lax $.**{2}');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"a": {"b": 1}}', 'lax $.**{3}');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '[]', '$.[*]');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '[1]', '$.[*]');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '[1]', '$.[1]');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '[1]', 'strict $.[1]');
ERROR:  Invalid SQL/JSON subscript
select _jsonpath_exists(jsonb '[1]', '$.[0]');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '[1]', '$.[0.3]');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '[1]', '$.[0.5]');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '[1]', '$.[0.9]');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '[1]', '$.[1.2]');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '[1]', 'strict $.[1.2]');
ERROR:  Invalid SQL/JSON subscript
select _jsonpath_exists(jsonb '{"a": [1,2,3], "b": [3,4,5]}', '$ ? (@.a[*] >  @.b[*])');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '{"a": [1,2,3], "b": [3,4,5]}', '$ ? (@.a[*] >= @.b[*])');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"a": [1,2,3], "b": [3,4,"5"]}', '$ ? (@.a[*] >= @.b[*])');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"a": [1,2,3], "b": [3,4,"5"]}', 'strict $ ? (@.a[*] >= @.b[*])');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '{"a": [1,2,3], "b": [3,4,null]}', '$ ? (@.a[*] >= @.b[*])');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '1', '$ ? ((@ == "1") is unknown)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '1', '$ ? ((@ == 1) is unknown)');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '[{"a": 1}, {"a": 2}]', '$[0 to 1] ? (@.a > 1)');
 _jsonpath_exists 
------------------
 t
(1 row)

select * from _jsonpath_query(jsonb '{"a": 12, "b": {"a": 13}}', '$.a');
 _jsonpath_query 
-----------------
 12
(1 row)

select * from _jsonpath_query(jsonb '{"a": 12, "b": {"a": 13}}', '$.b');
 _jsonpath_query 
-----------------
 {"a": 13}
(1 row)

select * from _jsonpath_query(jsonb '{"a": 12, "b": {"a": 13}}', '$.*');
 _jsonpath_query 
-----------------
 12
 {"a": 13}
(2 rows)

select * from _jsonpath_query(jsonb '{"a": 12, "b": {"a": 13}}', 'lax $.*.a');
 _jsonpath_query 
-----------------
 13
(1 row)

select * from _jsonpath_query(jsonb '[12, {"a": 13}, {"b": 14}]', 'lax $.[*].a');
 _jsonpath_query 
-----------------
 13
(1 row)

select * from _jsonpath_query(jsonb '[12, {"a": 13}, {"b": 14}]', 'lax $.[*].*');
 _jsonpath_query 
-----------------
 13
 14
(2 rows)

select * from _jsonpath_query(jsonb '[12, {"a": 13}, {"b": 14}]', 'lax $.[0].a');
 _jsonpath_query 
-----------------
(0 rows)

select * from _jsonpath_query(jsonb '[12, {"a": 13}, {"b": 14}]', 'lax $.[1].a');
 _jsonpath_query 
-----------------
 13
(1 row)

select * from _jsonpath_query(jsonb '[12, {"a": 13}, {"b": 14}]', 'lax $.[2].a');
 _jsonpath_query 
-----------------
(0 rows)

select * from _jsonpath_query(jsonb '[12, {"a": 13}, {"b": 14}]', 'lax $.[0,1].a');
 _jsonpath_query 
-----------------
 13
(1 row)

select * from _jsonpath_query(jsonb '[12, {"a": 13}, {"b": 14}]', 'lax $.[0 to 10].a');
 _jsonpath_query 
-----------------
 13
(1 row)

select * from _jsonpath_query(jsonb '[12, {"a": 13}, {"b": 14}, "ccc", true]', '$.[2.5 - 1 to @.size() - 2]');
 _jsonpath_query 
-----------------
 {"a": 13}
 {"b": 14}
 "ccc"
(3 rows)

select * from _jsonpath_query(jsonb '1', 'lax $[0]');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '1', 'lax $[*]');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '[1]', 'lax $[0]');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '[1]', 'lax $[*]');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '[1,2,3]', 'lax $[*]');
 _jsonpath_query 
-----------------
 1
 2
 3
(3 rows)

select * from _jsonpath_query(jsonb '[]', '$[last]');
 _jsonpath_query 
-----------------
(0 rows)

select * from _jsonpath_query(jsonb '[]', 'strict $[last]');
ERROR:  Invalid SQL/JSON subscript
select * from _jsonpath_query(jsonb '[1]', '$[last]');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '[1,2,3]', '$[last]');
 _jsonpath_query 
-----------------
 3
(1 row)

select * from _jsonpath_query(jsonb '[1,2,3]', '$[last - 1]');
 _jsonpath_query 
-----------------
 2
(1 row)

select * from _jsonpath_query(jsonb '[1,2,3]', '$[last ? (@.type() == "number")]');
 _jsonpath_query 
-----------------
 3
(1 row)

select * from _jsonpath_query(jsonb '[1,2,3]', '$[last ? (@.type() == "string")]');
ERROR:  Invalid SQL/JSON subscript
select * from _jsonpath_query(jsonb '{"a": 10}', '$');
 _jsonpath_query 
-----------------
 {"a": 10}
(1 row)

select * from _jsonpath_query(jsonb '{"a": 10}', '$ ? (.a < $value)');
ERROR:  could not find 'value' passed variable
select * from _jsonpath_query(jsonb '{"a": 10}', '$ ? (.a < $value)', '{"value" : 13}');
 _jsonpath_query 
-----------------
 {"a": 10}
(1 row)

select * from _jsonpath_query(jsonb '{"a": 10}', '$ ? (.a < $value)', '{"value" : 8}');
 _jsonpath_query 
-----------------
(0 rows)

select * from _jsonpath_query(jsonb '{"a": 10}', '$.a ? (@ < $value)', '{"value" : 13}');
 _jsonpath_query 
-----------------
 10
(1 row)

select * from _jsonpath_query(jsonb '[10,11,12,13,14,15]', '$.[*] ? (@ < $value)', '{"value" : 13}');
 _jsonpath_query 
-----------------
 10
 11
 12
(3 rows)

select * from _jsonpath_query(jsonb '[10,11,12,13,14,15]', '$.[0,1] ? (@ < $value)', '{"value" : 13}');
 _jsonpath_query 
-----------------
 10
 11
(2 rows)

select * from _jsonpath_query(jsonb '[10,11,12,13,14,15]', '$.[0 to 2] ? (@ < $value)', '{"value" : 15}');
 _jsonpath_query 
-----------------
 10
 11
 12
(3 rows)

select * from _jsonpath_query(jsonb '[1,"1",2,"2",null]', '$.[*] ? (@ == "1")');
 _jsonpath_query 
-----------------
 "1"
(1 row)

select * from _jsonpath_query(jsonb '[1,"1",2,"2",null]', '$.[*] ? (@ == $value)', '{"value" : "1"}');
 _jsonpath_query 
-----------------
 "1"
(1 row)

select * from _jsonpath_query(jsonb '[1, "2", null]', '$[*] ? (@ != null)');
 _jsonpath_query 
-----------------
 1
 "2"
(2 rows)

select * from _jsonpath_query(jsonb '[1, "2", null]', '$[*] ? (@ == null)');
 _jsonpath_query 
-----------------
 null
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', 'lax $.**');
 _jsonpath_query 
-----------------
 {"a": {"b": 1}}
 {"b": 1}
 1
(3 rows)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', 'lax $.**{1}');
 _jsonpath_query 
-----------------
 {"b": 1}
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', 'lax $.**{1,}');
 _jsonpath_query 
-----------------
 {"b": 1}
 1
(2 rows)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', 'lax $.**{2}');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', 'lax $.**{2,}');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', 'lax $.**{3,}');
 _jsonpath_query 
-----------------
(0 rows)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', 'lax $.**.b ? (@ > 0)');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', 'lax $.**{0}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
(0 rows)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', 'lax $.**{1}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', 'lax $.**{0,}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', 'lax $.**{1,}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"b": 1}}', 'lax $.**{1,2}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"c": {"b": 1}}}', 'lax $.**.b ? (@ > 0)');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"c": {"b": 1}}}', 'lax $.**{0}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
(0 rows)

select * from _jsonpath_query(jsonb '{"a": {"c": {"b": 1}}}', 'lax $.**{1}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
(0 rows)

select * from _jsonpath_query(jsonb '{"a": {"c": {"b": 1}}}', 'lax $.**{0,}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"c": {"b": 1}}}', 'lax $.**{1,}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"c": {"b": 1}}}', 'lax $.**{1,2}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_query(jsonb '{"a": {"c": {"b": 1}}}', 'lax $.**{2,3}.b ? (@ > 0)');
 _jsonpath_query 
-----------------
 1
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"b": 1}}', '$.**.b ? ( @ > 0)');
 _jsonpath_exists 
------------------
 t
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"b": 1}}', '$.**{0}.b ? ( @ > 0)');
 _jsonpath_exists 
------------------
 f
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"b": 1}}', '$.**{1}.b ? ( @ > 0)');
 _jsonpath_exists 
------------------
 t
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"b": 1}}', '$.**{0,}.b ? ( @ > 0)');
 _jsonpath_exists 
------------------
 t
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"b": 1}}', '$.**{1,}.b ? ( @ > 0)');
 _jsonpath_exists 
------------------
 t
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"b": 1}}', '$.**{1,2}.b ? ( @ > 0)');
 _jsonpath_exists 
------------------
 t
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"c": {"b": 1}}}', '$.**.b ? ( @ > 0)');
 _jsonpath_exists 
------------------
 t
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"c": {"b": 1}}}', '$.**{0}.b ? ( @ > 0)');
 _jsonpath_exists 
------------------
 f
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"c": {"b": 1}}}', '$.**{1}.b ? ( @ > 0)');
 _jsonpath_exists 
------------------
 f
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"c": {"b": 1}}}', '$.**{0,}.b ? ( @ > 0)');
 _jsonpath_exists 
------------------
 t
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"c": {"b": 1}}}', '$.**{1,}.b ? ( @ > 0)');
 _jsonpath_exists 
------------------
 t
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"c": {"b": 1}}}', '$.**{1,2}.b ? ( @ > 0)');
 _jsonpath_exists 
------------------
 t
(1 row)

select * from _jsonpath_exists(jsonb '{"a": {"c": {"b": 1}}}', '$.**{2,3}.b ? ( @ > 0)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_query(jsonb '{"g": {"x": 2}}', '$.g ? (exists (@.x))');
 _jsonpath_query 
-----------------
 {"x": 2}
(1 row)

select _jsonpath_query(jsonb '{"g": {"x": 2}}', '$.g ? (exists (@.y))');
 _jsonpath_query 
-----------------
(0 rows)

select _jsonpath_query(jsonb '{"g": {"x": 2}}', '$.g ? (exists (@.x ? (@ >= 2) ))');
 _jsonpath_query 
-----------------
 {"x": 2}
(1 row)

--test ternary logic
select
	x, y,
	_jsonpath_query(
		jsonb '[true, false, null]',
		'$[*] ? (@ == true  &&  ($x == true && $y == true) ||
				 @ == false && !($x == true && $y == true) ||
				 @ == null  &&  ($x == true && $y == true) is unknown)',
		jsonb_build_object('x', x, 'y', y)
	) as "x && y"
from
	(values (jsonb 'true'), ('false'), ('"null"')) x(x),
	(values (jsonb 'true'), ('false'), ('"null"')) y(y);
   x    |   y    | x && y 
--------+--------+--------
 true   | true   | true
 true   | false  | false
 true   | "null" | null
 false  | true   | false
 false  | false  | false
 false  | "null" | false
 "null" | true   | null
 "null" | false  | false
 "null" | "null" | null
(9 rows)

select
	x, y,
	_jsonpath_query(
		jsonb '[true, false, null]',
		'$[*] ? (@ == true  &&  ($x == true || $y == true) ||
				 @ == false && !($x == true || $y == true) ||
				 @ == null  &&  ($x == true || $y == true) is unknown)',
		jsonb_build_object('x', x, 'y', y)
	) as "x || y"
from
	(values (jsonb 'true'), ('false'), ('"null"')) x(x),
	(values (jsonb 'true'), ('false'), ('"null"')) y(y);
   x    |   y    | x || y 
--------+--------+--------
 true   | true   | true
 true   | false  | true
 true   | "null" | true
 false  | true   | true
 false  | false  | false
 false  | "null" | null
 "null" | true   | true
 "null" | false  | null
 "null" | "null" | null
(9 rows)

select _jsonpath_exists(jsonb '{"a": 1, "b":1}', '$ ? (.a == .b)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"c": {"a": 1, "b":1}}', '$ ? (.a == .b)');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '{"c": {"a": 1, "b":1}}', '$.c ? (.a == .b)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"c": {"a": 1, "b":1}}', '$.c ? ($.c.a == .b)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"c": {"a": 1, "b":1}}', '$.* ? (.a == .b)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"a": 1, "b":1}', '$.** ? (.a == .b)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"c": {"a": 1, "b":1}}', '$.** ? (.a == .b)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_query(jsonb '{"c": {"a": 2, "b":1}}', '$.** ? (.a == 1 + 1)');
 _jsonpath_query  
------------------
 {"a": 2, "b": 1}
(1 row)

select _jsonpath_query(jsonb '{"c": {"a": 2, "b":1}}', '$.** ? (.a == (1 + 1))');
 _jsonpath_query  
------------------
 {"a": 2, "b": 1}
(1 row)

select _jsonpath_query(jsonb '{"c": {"a": 2, "b":1}}', '$.** ? (.a == .b + 1)');
 _jsonpath_query  
------------------
 {"a": 2, "b": 1}
(1 row)

select _jsonpath_query(jsonb '{"c": {"a": 2, "b":1}}', '$.** ? (.a == (.b + 1))');
 _jsonpath_query  
------------------
 {"a": 2, "b": 1}
(1 row)

select _jsonpath_exists(jsonb '{"c": {"a": -1, "b":1}}', '$.** ? (.a == - 1)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"c": {"a": -1, "b":1}}', '$.** ? (.a == -1)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"c": {"a": -1, "b":1}}', '$.** ? (.a == -.b)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"c": {"a": -1, "b":1}}', '$.** ? (.a == - .b)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"c": {"a": 0, "b":1}}', '$.** ? (.a == 1 - .b)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"c": {"a": 2, "b":1}}', '$.** ? (.a == 1 - - .b)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '{"c": {"a": 0, "b":1}}', '$.** ? (.a == 1 - +.b)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '[1,2,3]', '$ ? (+@[*] > +2)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '[1,2,3]', '$ ? (+@[*] > +3)');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '[1,2,3]', '$ ? (-@[*] < -2)');
 _jsonpath_exists 
------------------
 t
(1 row)

select _jsonpath_exists(jsonb '[1,2,3]', '$ ? (-@[*] < -3)');
 _jsonpath_exists 
------------------
 f
(1 row)

select _jsonpath_exists(jsonb '1', '$ ? ($ > 0)');
 _jsonpath_exists 
------------------
 t
(1 row)

-- unwrapping of operator arguments in lax mode
select _jsonpath_query(jsonb '{"a": [2]}', 'lax $.a * 3');
 _jsonpath_query 
-----------------
 6
(1 row)

select _jsonpath_query(jsonb '{"a": [2]}', 'lax $.a + 3');
 _jsonpath_query 
-----------------
 5
(1 row)

select _jsonpath_query(jsonb '{"a": [2, 3, 4]}', 'lax -$.a');
 _jsonpath_query 
-----------------
 -2
 -3
 -4
(3 rows)

-- should fail
select _jsonpath_query(jsonb '{"a": [1, 2]}', 'lax $.a * 3');
ERROR:  Singleton SQL/JSON item required
-- extension: boolean expressions
select _jsonpath_query(jsonb '2', '$ > 1');
 _jsonpath_query 
-----------------
 true
(1 row)

select _jsonpath_query(jsonb '2', '$ <= 1');
 _jsonpath_query 
-----------------
 false
(1 row)

select _jsonpath_query(jsonb '2', '$ == "2"');
 _jsonpath_query 
-----------------
 null
(1 row)

select _jsonpath_predicate(jsonb '2', '$ > 1');
 _jsonpath_predicate 
---------------------
 t
(1 row)

select _jsonpath_predicate(jsonb '2', '$ <= 1');
 _jsonpath_predicate 
---------------------
 f
(1 row)

select _jsonpath_predicate(jsonb '2', '$ == "2"');
 _jsonpath_predicate 
---------------------
 
(1 row)

select _jsonpath_predicate(jsonb '2', '1');
 _jsonpath_predicate 
---------------------
 
(1 row)

select _jsonpath_predicate(jsonb '{}', '$');
 _jsonpath_predicate 
---------------------
 
(1 row)

select _jsonpath_predicate(jsonb '[]', '$');
 _jsonpath_predicate 
---------------------
 
(1 row)

select _jsonpath_predicate(jsonb '[1,2,3]', '$[*]');
ERROR:  Singleton SQL/JSON item required
select _jsonpath_predicate(jsonb '[]', '$[*]');
ERROR:  Singleton SQL/JSON item required
select _jsonpath_predicate(jsonb '[[1, true], [2, false]]', 'strict $[*] ? (@[0] > $x) [1]', '{"x": 1}');
 _jsonpath_predicate 
---------------------
 f
(1 row)

select _jsonpath_predicate(jsonb '[[1, true], [2, false]]', 'strict $[*] ? (@[0] < $x) [1]', '{"x": 2}');
 _jsonpath_predicate 
---------------------
 t
(1 row)

select _jsonpath_query(jsonb '[null,1,true,"a",[],{}]', '$.type()');
 _jsonpath_query 
-----------------
 "array"
(1 row)

select _jsonpath_query(jsonb '[null,1,true,"a",[],{}]', 'lax $.type()');
 _jsonpath_query 
-----------------
 "array"
(1 row)

select _jsonpath_query(jsonb '[null,1,true,"a",[],{}]', '$[*].type()');
 _jsonpath_query 
-----------------
 "null"
 "number"
 "boolean"
 "string"
 "array"
 "object"
(6 rows)

select _jsonpath_query(jsonb 'null', 'null.type()');
 _jsonpath_query 
-----------------
 "null"
(1 row)

select _jsonpath_query(jsonb 'null', 'true.type()');
 _jsonpath_query 
-----------------
 "boolean"
(1 row)

select _jsonpath_query(jsonb 'null', '123.type()');
 _jsonpath_query 
-----------------
 "number"
(1 row)

select _jsonpath_query(jsonb 'null', '"123".type()');
 _jsonpath_query 
-----------------
 "string"
(1 row)

select _jsonpath_query(jsonb 'null', 'aaa.type()');
 _jsonpath_query 
-----------------
 "string"
(1 row)

select _jsonpath_query(jsonb '{"a": 2}', '($.a - 5).abs() + 10');
 _jsonpath_query 
-----------------
 13
(1 row)

select _jsonpath_query(jsonb '{"a": 2.5}', '-($.a * $.a).floor() + 10');
 _jsonpath_query 
-----------------
 4
(1 row)

select _jsonpath_query(jsonb '[1, 2, 3]', '($[*] > 2) ? (@ == true)');
 _jsonpath_query 
-----------------
 true
(1 row)

select _jsonpath_query(jsonb '[1, 2, 3]', '($[*] > 3).type()');
 _jsonpath_query 
-----------------
 "boolean"
(1 row)

select _jsonpath_query(jsonb '[1, 2, 3]', '($[*].a > 3).type()');
 _jsonpath_query 
-----------------
 "boolean"
(1 row)

select _jsonpath_query(jsonb '[1, 2, 3]', 'strict ($[*].a > 3).type()');
 _jsonpath_query 
-----------------
 "null"
(1 row)

select _jsonpath_query(jsonb '[1,null,true,"11",[],[1],[1,2,3],{},{"a":1,"b":2}]', 'strict $[*].size()');
ERROR:  SQL/JSON array not found
select _jsonpath_query(jsonb '[1,null,true,"11",[],[1],[1,2,3],{},{"a":1,"b":2}]', 'lax $[*].size()');
 _jsonpath_query 
-----------------
 1
 1
 1
 1
 0
 1
 3
 1
 1
(9 rows)

select _jsonpath_query(jsonb '[0, 1, -2, -3.4, 5.6]', '$[*].abs()');
 _jsonpath_query 
-----------------
 0
 1
 2
 3.4
 5.6
(5 rows)

select _jsonpath_query(jsonb '[0, 1, -2, -3.4, 5.6]', '$[*].floor()');
 _jsonpath_query 
-----------------
 0
 1
 -2
 -4
 5
(5 rows)

select _jsonpath_query(jsonb '[0, 1, -2, -3.4, 5.6]', '$[*].ceiling()');
 _jsonpath_query 
-----------------
 0
 1
 -2
 -3
 6
(5 rows)

select _jsonpath_query(jsonb '[0, 1, -2, -3.4, 5.6]', '$[*].ceiling().abs()');
 _jsonpath_query 
-----------------
 0
 1
 2
 3
 6
(5 rows)

select _jsonpath_query(jsonb '[0, 1, -2, -3.4, 5.6]', '$[*].ceiling().abs().type()');
 _jsonpath_query 
-----------------
 "number"
 "number"
 "number"
 "number"
 "number"
(5 rows)

select _jsonpath_query(jsonb '[{},1]', '$[*].keyvalue()');
ERROR:  SQL/JSON object not found
select _jsonpath_query(jsonb '{}', '$.keyvalue()');
 _jsonpath_query 
-----------------
(0 rows)

select _jsonpath_query(jsonb '{"a": 1, "b": [1, 2], "c": {"a": "bbb"}}', '$.keyvalue()');
           _jsonpath_query           
-------------------------------------
 {"key": "a", "value": 1}
 {"key": "b", "value": [1, 2]}
 {"key": "c", "value": {"a": "bbb"}}
(3 rows)

select _jsonpath_query(jsonb '[{"a": 1, "b": [1, 2]}, {"c": {"a": "bbb"}}]', '$[*].keyvalue()');
           _jsonpath_query           
-------------------------------------
 {"key": "a", "value": 1}
 {"key": "b", "value": [1, 2]}
 {"key": "c", "value": {"a": "bbb"}}
(3 rows)

select _jsonpath_query(jsonb '[{"a": 1, "b": [1, 2]}, {"c": {"a": "bbb"}}]', 'strict $.keyvalue()');
ERROR:  SQL/JSON object not found
select _jsonpath_query(jsonb '[{"a": 1, "b": [1, 2]}, {"c": {"a": "bbb"}}]', 'lax $.keyvalue()');
           _jsonpath_query           
-------------------------------------
 {"key": "a", "value": 1}
 {"key": "b", "value": [1, 2]}
 {"key": "c", "value": {"a": "bbb"}}
(3 rows)

select _jsonpath_query(jsonb 'null', '$.double()');
ERROR:  Non-numeric SQL/JSON item
select _jsonpath_query(jsonb 'true', '$.double()');
ERROR:  Non-numeric SQL/JSON item
select _jsonpath_query(jsonb '[]', '$.double()');
 _jsonpath_query 
-----------------
(0 rows)

select _jsonpath_query(jsonb '[]', 'strict $.double()');
ERROR:  Non-numeric SQL/JSON item
select _jsonpath_query(jsonb '{}', '$.double()');
ERROR:  Non-numeric SQL/JSON item
select _jsonpath_query(jsonb '1.23', '$.double()');
 _jsonpath_query 
-----------------
 1.23
(1 row)

select _jsonpath_query(jsonb '"1.23"', '$.double()');
 _jsonpath_query 
-----------------
 1.23
(1 row)

select _jsonpath_query(jsonb '"1.23aaa"', '$.double()');
ERROR:  Non-numeric SQL/JSON item
select _jsonpath_query(jsonb '["", "a", "abc", "abcabc"]', '$[*] ? (@ starts with "abc")');
 _jsonpath_query 
-----------------
 "abc"
 "abcabc"
(2 rows)

select _jsonpath_query(jsonb '["", "a", "abc", "abcabc"]', 'strict $ ? (@[*] starts with "abc")');
      _jsonpath_query       
----------------------------
 ["", "a", "abc", "abcabc"]
(1 row)

select _jsonpath_query(jsonb '["", "a", "abd", "abdabc"]', 'strict $ ? (@[*] starts with "abc")');
 _jsonpath_query 
-----------------
(0 rows)

select _jsonpath_query(jsonb '["abc", "abcabc", null, 1]', 'strict $ ? (@[*] starts with "abc")');
 _jsonpath_query 
-----------------
(0 rows)

select _jsonpath_query(jsonb '["abc", "abcabc", null, 1]', 'strict $ ? ((@[*] starts with "abc") is unknown)');
      _jsonpath_query       
----------------------------
 ["abc", "abcabc", null, 1]
(1 row)

select _jsonpath_query(jsonb '[[null, 1, "abc", "abcabc"]]', 'lax $ ? (@[*] starts with "abc")');
      _jsonpath_query       
----------------------------
 [null, 1, "abc", "abcabc"]
(1 row)

select _jsonpath_query(jsonb '[[null, 1, "abd", "abdabc"]]', 'lax $ ? ((@[*] starts with "abc") is unknown)');
      _jsonpath_query       
----------------------------
 [null, 1, "abd", "abdabc"]
(1 row)

select _jsonpath_query(jsonb '[null, 1, "abd", "abdabc"]', 'lax $[*] ? ((@ starts with "abc") is unknown)');
 _jsonpath_query 
-----------------
 null
 1
(2 rows)

select _jsonpath_query(jsonb '[null, 1, "abc", "abd", "aBdC", "abdacb", "babc"]', 'lax $[*] ? (@ like_regex "^ab.*c")');
 _jsonpath_query 
-----------------
 "abc"
 "abdacb"
(2 rows)

select _jsonpath_query(jsonb '[null, 1, "abc", "abd", "aBdC", "abdacb", "babc"]', 'lax $[*] ? (@ like_regex "^ab.*c" flag "i")');
 _jsonpath_query 
-----------------
 "abc"
 "aBdC"
 "abdacb"
(3 rows)

select _jsonpath_query(jsonb 'null', '$.datetime()');
ERROR:  Invalid argument for SQL/JSON datetime function
select _jsonpath_query(jsonb 'true', '$.datetime()');
ERROR:  Invalid argument for SQL/JSON datetime function
select _jsonpath_query(jsonb '[]', '$.datetime()');
 _jsonpath_query 
-----------------
(0 rows)

select _jsonpath_query(jsonb '[]', 'strict $.datetime()');
ERROR:  Invalid argument for SQL/JSON datetime function
select _jsonpath_query(jsonb '{}', '$.datetime()');
ERROR:  Invalid argument for SQL/JSON datetime function
select _jsonpath_query(jsonb '""', '$.datetime()');
ERROR:  Invalid argument for SQL/JSON datetime function
-- Standard extension: UNIX epoch to timestamptz
select _jsonpath_query(jsonb '0', '$.datetime()');
        _jsonpath_query         
--------------------------------
 "Wed Dec 31 16:00:00 1969 PST"
(1 row)

select _jsonpath_query(jsonb '0', '$.datetime().type()');
      _jsonpath_query       
----------------------------
 "timestamp with time zone"
(1 row)

select _jsonpath_query(jsonb '1490216035.5', '$.datetime()');
         _jsonpath_query          
----------------------------------
 "Wed Mar 22 13:53:55.5 2017 PDT"
(1 row)

select _jsonpath_query(jsonb '"10-03-2017"',       '$.datetime("dd-mm-yyyy")');
 _jsonpath_query 
-----------------
 "03-10-2017"
(1 row)

select _jsonpath_query(jsonb '"10-03-2017"',       '$.datetime("dd-mm-yyyy").type()');
 _jsonpath_query 
-----------------
 "date"
(1 row)

select _jsonpath_query(jsonb '"10-03-2017 12:34"', '$.datetime("dd-mm-yyyy")');
 _jsonpath_query 
-----------------
 "03-10-2017"
(1 row)

select _jsonpath_query(jsonb '"10-03-2017 12:34"', '$.datetime("dd-mm-yyyy").type()');
 _jsonpath_query 
-----------------
 "date"
(1 row)

select _jsonpath_query(jsonb '"10-03-2017 12:34"', '       $.datetime("dd-mm-yyyy HH24:MI").type()');
        _jsonpath_query        
-------------------------------
 "timestamp without time zone"
(1 row)

select _jsonpath_query(jsonb '"10-03-2017 12:34 +05:20"', '$.datetime("dd-mm-yyyy HH24:MI TZH:TZM").type()');
      _jsonpath_query       
----------------------------
 "timestamp with time zone"
(1 row)

select _jsonpath_query(jsonb '"12:34:56"',                '$.datetime("HH24:MI:SS").type()');
     _jsonpath_query      
--------------------------
 "time without time zone"
(1 row)

select _jsonpath_query(jsonb '"12:34:56 +05:20"',         '$.datetime("HH24:MI:SS TZH:TZM").type()');
    _jsonpath_query    
-----------------------
 "time with time zone"
(1 row)

set time zone '+00';
select _jsonpath_query(jsonb '"10-03-2017 12:34"',        '$.datetime("dd-mm-yyyy HH24:MI")');
      _jsonpath_query       
----------------------------
 "Fri Mar 10 12:34:00 2017"
(1 row)

select _jsonpath_query(jsonb '"10-03-2017 12:34"',        '$.datetime("dd-mm-yyyy HH24:MI TZH")');
        _jsonpath_query         
--------------------------------
 "Fri Mar 10 12:34:00 2017 +00"
(1 row)

select _jsonpath_query(jsonb '"10-03-2017 12:34 +05"',    '$.datetime("dd-mm-yyyy HH24:MI TZH")');
        _jsonpath_query         
--------------------------------
 "Fri Mar 10 07:34:00 2017 +00"
(1 row)

select _jsonpath_query(jsonb '"10-03-2017 12:34 -05"',    '$.datetime("dd-mm-yyyy HH24:MI TZH")');
        _jsonpath_query         
--------------------------------
 "Fri Mar 10 17:34:00 2017 +00"
(1 row)

select _jsonpath_query(jsonb '"10-03-2017 12:34 +05:20"', '$.datetime("dd-mm-yyyy HH24:MI TZH:TZM")');
        _jsonpath_query         
--------------------------------
 "Fri Mar 10 07:14:00 2017 +00"
(1 row)

select _jsonpath_query(jsonb '"10-03-2017 12:34 -05:20"', '$.datetime("dd-mm-yyyy HH24:MI TZH:TZM")');
        _jsonpath_query         
--------------------------------
 "Fri Mar 10 17:54:00 2017 +00"
(1 row)

select _jsonpath_query(jsonb '"12:34"',       '$.datetime("HH24:MI")');
 _jsonpath_query 
-----------------
 "12:34:00"
(1 row)

select _jsonpath_query(jsonb '"12:34"',       '$.datetime("HH24:MI TZH")');
 _jsonpath_query 
-----------------
 "12:34:00+00"
(1 row)

select _jsonpath_query(jsonb '"12:34 +05"',    '$.datetime("HH24:MI TZH")');
 _jsonpath_query 
-----------------
 "12:34:00+05"
(1 row)

select _jsonpath_query(jsonb '"12:34 -05"',    '$.datetime("HH24:MI TZH")');
 _jsonpath_query 
-----------------
 "12:34:00-05"
(1 row)

select _jsonpath_query(jsonb '"12:34 +05:20"', '$.datetime("HH24:MI TZH:TZM")');
 _jsonpath_query  
------------------
 "12:34:00+05:20"
(1 row)

select _jsonpath_query(jsonb '"12:34 -05:20"', '$.datetime("HH24:MI TZH:TZM")');
 _jsonpath_query  
------------------
 "12:34:00-05:20"
(1 row)

set time zone '+10';
select _jsonpath_query(jsonb '"10-03-2017 12:34"',       '$.datetime("dd-mm-yyyy HH24:MI")');
      _jsonpath_query       
----------------------------
 "Fri Mar 10 12:34:00 2017"
(1 row)

select _jsonpath_query(jsonb '"10-03-2017 12:34"',        '$.datetime("dd-mm-yyyy HH24:MI TZH")');
        _jsonpath_query         
--------------------------------
 "Fri Mar 10 12:34:00 2017 +10"
(1 row)

select _jsonpath_query(jsonb '"10-03-2017 12:34 +05"',    '$.datetime("dd-mm-yyyy HH24:MI TZH")');
        _jsonpath_query         
--------------------------------
 "Fri Mar 10 17:34:00 2017 +10"
(1 row)

select _jsonpath_query(jsonb '"10-03-2017 12:34 -05"',    '$.datetime("dd-mm-yyyy HH24:MI TZH")');
        _jsonpath_query         
--------------------------------
 "Sat Mar 11 03:34:00 2017 +10"
(1 row)

select _jsonpath_query(jsonb '"10-03-2017 12:34 +05:20"', '$.datetime("dd-mm-yyyy HH24:MI TZH:TZM")');
        _jsonpath_query         
--------------------------------
 "Fri Mar 10 17:14:00 2017 +10"
(1 row)

select _jsonpath_query(jsonb '"10-03-2017 12:34 -05:20"', '$.datetime("dd-mm-yyyy HH24:MI TZH:TZM")');
        _jsonpath_query         
--------------------------------
 "Sat Mar 11 03:54:00 2017 +10"
(1 row)

select _jsonpath_query(jsonb '"12:34"',        '$.datetime("HH24:MI")');
 _jsonpath_query 
-----------------
 "12:34:00"
(1 row)

select _jsonpath_query(jsonb '"12:34"',        '$.datetime("HH24:MI TZH")');
 _jsonpath_query 
-----------------
 "12:34:00+10"
(1 row)

select _jsonpath_query(jsonb '"12:34 +05"',    '$.datetime("HH24:MI TZH")');
 _jsonpath_query 
-----------------
 "12:34:00+05"
(1 row)

select _jsonpath_query(jsonb '"12:34 -05"',    '$.datetime("HH24:MI TZH")');
 _jsonpath_query 
-----------------
 "12:34:00-05"
(1 row)

select _jsonpath_query(jsonb '"12:34 +05:20"', '$.datetime("HH24:MI TZH:TZM")');
 _jsonpath_query  
------------------
 "12:34:00+05:20"
(1 row)

select _jsonpath_query(jsonb '"12:34 -05:20"', '$.datetime("HH24:MI TZH:TZM")');
 _jsonpath_query  
------------------
 "12:34:00-05:20"
(1 row)

set time zone default;
select _jsonpath_query(jsonb '"2017-03-10"', '$.datetime().type()');
 _jsonpath_query 
-----------------
 "date"
(1 row)

select _jsonpath_query(jsonb '"2017-03-10"', '$.datetime()');
 _jsonpath_query 
-----------------
 "03-10-2017"
(1 row)

select _jsonpath_query(jsonb '"2017-03-10 12:34:56"', '$.datetime().type()');
        _jsonpath_query        
-------------------------------
 "timestamp without time zone"
(1 row)

select _jsonpath_query(jsonb '"2017-03-10 12:34:56"', '$.datetime()');
      _jsonpath_query       
----------------------------
 "Fri Mar 10 12:34:56 2017"
(1 row)

select _jsonpath_query(jsonb '"2017-03-10 12:34:56 +3"', '$.datetime().type()');
      _jsonpath_query       
----------------------------
 "timestamp with time zone"
(1 row)

select _jsonpath_query(jsonb '"2017-03-10 12:34:56 +3"', '$.datetime()');
        _jsonpath_query         
--------------------------------
 "Fri Mar 10 01:34:56 2017 PST"
(1 row)

select _jsonpath_query(jsonb '"2017-03-10 12:34:56 +3:10"', '$.datetime().type()');
      _jsonpath_query       
----------------------------
 "timestamp with time zone"
(1 row)

select _jsonpath_query(jsonb '"2017-03-10 12:34:56 +3:10"', '$.datetime()');
        _jsonpath_query         
--------------------------------
 "Fri Mar 10 01:24:56 2017 PST"
(1 row)

select _jsonpath_query(jsonb '"12:34:56"', '$.datetime().type()');
     _jsonpath_query      
--------------------------
 "time without time zone"
(1 row)

select _jsonpath_query(jsonb '"12:34:56"', '$.datetime()');
 _jsonpath_query 
-----------------
 "12:34:56"
(1 row)

select _jsonpath_query(jsonb '"12:34:56 +3"', '$.datetime().type()');
    _jsonpath_query    
-----------------------
 "time with time zone"
(1 row)

select _jsonpath_query(jsonb '"12:34:56 +3"', '$.datetime()');
 _jsonpath_query 
-----------------
 "12:34:56+03"
(1 row)

select _jsonpath_query(jsonb '"12:34:56 +3:10"', '$.datetime().type()');
    _jsonpath_query    
-----------------------
 "time with time zone"
(1 row)

select _jsonpath_query(jsonb '"12:34:56 +3:10"', '$.datetime()');
 _jsonpath_query  
------------------
 "12:34:56+03:10"
(1 row)

set time zone '+00';
-- date comparison
select _jsonpath_query(jsonb
	'["2017-03-10", "2017-03-11", "2017-03-09", "12:34:56", "01:02:03 +04", "2017-03-10 00:00:00", "2017-03-10 12:34:56", "2017-03-10 01:02:03 +04", "2017-03-10 03:00:00 +03"]',
	'$[*].datetime() ? (@ == "10.03.2017".datetime("dd.mm.yyyy"))'
);
        _jsonpath_query         
--------------------------------
 "03-10-2017"
 "Fri Mar 10 00:00:00 2017"
 "Fri Mar 10 00:00:00 2017 +00"
(3 rows)

select _jsonpath_query(jsonb
	'["2017-03-10", "2017-03-11", "2017-03-09", "12:34:56", "01:02:03 +04", "2017-03-10 00:00:00", "2017-03-10 12:34:56", "2017-03-10 01:02:03 +04", "2017-03-10 03:00:00 +03"]',
	'$[*].datetime() ? (@ >= "10.03.2017".datetime("dd.mm.yyyy"))'
);
        _jsonpath_query         
--------------------------------
 "03-10-2017"
 "03-11-2017"
 "Fri Mar 10 00:00:00 2017"
 "Fri Mar 10 12:34:56 2017"
 "Fri Mar 10 00:00:00 2017 +00"
(5 rows)

select _jsonpath_query(jsonb
	'["2017-03-10", "2017-03-11", "2017-03-09", "12:34:56", "01:02:03 +04", "2017-03-10 00:00:00", "2017-03-10 12:34:56", "2017-03-10 01:02:03 +04", "2017-03-10 03:00:00 +03"]',
	'$[*].datetime() ? (@ <  "10.03.2017".datetime("dd.mm.yyyy"))'
);
        _jsonpath_query         
--------------------------------
 "03-09-2017"
 "Thu Mar 09 21:02:03 2017 +00"
(2 rows)

-- time comparison
select _jsonpath_query(jsonb
	'["12:34:00", "12:35:00", "12:36:00", "12:35:00 +00", "12:35:00 +01", "13:35:00 +01", "2017-03-10", "2017-03-10 12:35:00", "2017-03-10 12:35:00 +01"]',
	'$[*].datetime() ? (@ == "12:35".datetime("HH24:MI"))'
);
 _jsonpath_query 
-----------------
 "12:35:00"
 "12:35:00+00"
(2 rows)

select _jsonpath_query(jsonb
	'["12:34:00", "12:35:00", "12:36:00", "12:35:00 +00", "12:35:00 +01", "13:35:00 +01", "2017-03-10", "2017-03-10 12:35:00", "2017-03-10 12:35:00 +01"]',
	'$[*].datetime() ? (@ >= "12:35".datetime("HH24:MI"))'
);
 _jsonpath_query 
-----------------
 "12:35:00"
 "12:36:00"
 "12:35:00+00"
(3 rows)

select _jsonpath_query(jsonb
	'["12:34:00", "12:35:00", "12:36:00", "12:35:00 +00", "12:35:00 +01", "13:35:00 +01", "2017-03-10", "2017-03-10 12:35:00", "2017-03-10 12:35:00 +01"]',
	'$[*].datetime() ? (@ <  "12:35".datetime("HH24:MI"))'
);
 _jsonpath_query 
-----------------
 "12:34:00"
 "12:35:00+01"
 "13:35:00+01"
(3 rows)

-- timetz comparison
select _jsonpath_query(jsonb
	'["12:34:00 +01", "12:35:00 +01", "12:36:00 +01", "12:35:00 +02", "12:35:00 -02", "10:35:00", "11:35:00", "12:35:00", "2017-03-10", "2017-03-10 12:35:00", "2017-03-10 12:35:00 +1"]',
	'$[*].datetime() ? (@ == "12:35 +1".datetime("HH24:MI TZH"))'
);
 _jsonpath_query 
-----------------
 "12:35:00+01"
(1 row)

select _jsonpath_query(jsonb
	'["12:34:00 +01", "12:35:00 +01", "12:36:00 +01", "12:35:00 +02", "12:35:00 -02", "10:35:00", "11:35:00", "12:35:00", "2017-03-10", "2017-03-10 12:35:00", "2017-03-10 12:35:00 +1"]',
	'$[*].datetime() ? (@ >= "12:35 +1".datetime("HH24:MI TZH"))'
);
 _jsonpath_query 
-----------------
 "12:35:00+01"
 "12:36:00+01"
 "12:35:00-02"
 "11:35:00"
 "12:35:00"
(5 rows)

select _jsonpath_query(jsonb
	'["12:34:00 +01", "12:35:00 +01", "12:36:00 +01", "12:35:00 +02", "12:35:00 -02", "10:35:00", "11:35:00", "12:35:00", "2017-03-10", "2017-03-10 12:35:00", "2017-03-10 12:35:00 +1"]',
	'$[*].datetime() ? (@ <  "12:35 +1".datetime("HH24:MI TZH"))'
);
 _jsonpath_query 
-----------------
 "12:34:00+01"
 "12:35:00+02"
 "10:35:00"
(3 rows)

-- timestamp comparison
select _jsonpath_query(jsonb
	'["2017-03-10 12:34:00", "2017-03-10 12:35:00", "2017-03-10 12:36:00", "2017-03-10 12:35:00 +01", "2017-03-10 13:35:00 +01", "2017-03-10 12:35:00 -01", "2017-03-10", "2017-03-11", "12:34:56", "12:34:56 +01"]',
	'$[*].datetime() ? (@ == "10.03.2017 12:35".datetime("dd.mm.yyyy HH24:MI"))'
);
        _jsonpath_query         
--------------------------------
 "Fri Mar 10 12:35:00 2017"
 "Fri Mar 10 12:35:00 2017 +00"
(2 rows)

select _jsonpath_query(jsonb
	'["2017-03-10 12:34:00", "2017-03-10 12:35:00", "2017-03-10 12:36:00", "2017-03-10 12:35:00 +01", "2017-03-10 13:35:00 +01", "2017-03-10 12:35:00 -01", "2017-03-10", "2017-03-11", "12:34:56", "12:34:56 +01"]',
	'$[*].datetime() ? (@ >= "10.03.2017 12:35".datetime("dd.mm.yyyy HH24:MI"))'
);
        _jsonpath_query         
--------------------------------
 "Fri Mar 10 12:35:00 2017"
 "Fri Mar 10 12:36:00 2017"
 "Fri Mar 10 12:35:00 2017 +00"
 "Fri Mar 10 13:35:00 2017 +00"
 "03-11-2017"
(5 rows)

select _jsonpath_query(jsonb
	'["2017-03-10 12:34:00", "2017-03-10 12:35:00", "2017-03-10 12:36:00", "2017-03-10 12:35:00 +01", "2017-03-10 13:35:00 +01", "2017-03-10 12:35:00 -01", "2017-03-10", "2017-03-11", "12:34:56", "12:34:56 +01"]',
	'$[*].datetime() ? (@ < "10.03.2017 12:35".datetime("dd.mm.yyyy HH24:MI"))'
);
        _jsonpath_query         
--------------------------------
 "Fri Mar 10 12:34:00 2017"
 "Fri Mar 10 11:35:00 2017 +00"
 "03-10-2017"
(3 rows)

-- timestamptz comparison
select _jsonpath_query(jsonb
	'["2017-03-10 12:34:00 +01", "2017-03-10 12:35:00 +01", "2017-03-10 12:36:00 +01", "2017-03-10 12:35:00 +02", "2017-03-10 12:35:00 -02", "2017-03-10 10:35:00", "2017-03-10 11:35:00", "2017-03-10 12:35:00", "2017-03-10", "2017-03-11", "12:34:56", "12:34:56 +01"]',
	'$[*].datetime() ? (@ == "10.03.2017 12:35 +1".datetime("dd.mm.yyyy HH24:MI TZH"))'
);
        _jsonpath_query         
--------------------------------
 "Fri Mar 10 11:35:00 2017 +00"
 "Fri Mar 10 11:35:00 2017"
(2 rows)

select _jsonpath_query(jsonb
	'["2017-03-10 12:34:00 +01", "2017-03-10 12:35:00 +01", "2017-03-10 12:36:00 +01", "2017-03-10 12:35:00 +02", "2017-03-10 12:35:00 -02", "2017-03-10 10:35:00", "2017-03-10 11:35:00", "2017-03-10 12:35:00", "2017-03-10", "2017-03-11", "12:34:56", "12:34:56 +01"]',
	'$[*].datetime() ? (@ >= "10.03.2017 12:35 +1".datetime("dd.mm.yyyy HH24:MI TZH"))'
);
        _jsonpath_query         
--------------------------------
 "Fri Mar 10 11:35:00 2017 +00"
 "Fri Mar 10 11:36:00 2017 +00"
 "Fri Mar 10 14:35:00 2017 +00"
 "Fri Mar 10 11:35:00 2017"
 "Fri Mar 10 12:35:00 2017"
 "03-11-2017"
(6 rows)

select _jsonpath_query(jsonb
	'["2017-03-10 12:34:00 +01", "2017-03-10 12:35:00 +01", "2017-03-10 12:36:00 +01", "2017-03-10 12:35:00 +02", "2017-03-10 12:35:00 -02", "2017-03-10 10:35:00", "2017-03-10 11:35:00", "2017-03-10 12:35:00", "2017-03-10", "2017-03-11", "12:34:56", "12:34:56 +01"]',
	'$[*].datetime() ? (@ < "10.03.2017 12:35 +1".datetime("dd.mm.yyyy HH24:MI TZH"))'
);
        _jsonpath_query         
--------------------------------
 "Fri Mar 10 11:34:00 2017 +00"
 "Fri Mar 10 10:35:00 2017 +00"
 "Fri Mar 10 10:35:00 2017"
 "03-10-2017"
(4 rows)

set time zone default;
-- jsonpath operators
SELECT jsonb '[{"a": 1}, {"a": 2}]' @* '$[*]';
 ?column? 
----------
 {"a": 1}
 {"a": 2}
(2 rows)

SELECT jsonb '[{"a": 1}, {"a": 2}]' @* '$[*] ? (@.a > 10)';
 ?column? 
----------
(0 rows)

SELECT jsonb '[{"a": 1}, {"a": 2}]' @* '[$[*].a]';
 ?column? 
----------
 [1, 2]
(1 row)

SELECT jsonb '[{"a": 1}, {"a": 2}]' @? '$[*].a > 1';
 ?column? 
----------
 t
(1 row)

SELECT jsonb '[{"a": 1}, {"a": 2}]' @? '$[*].a > 2';
 ?column? 
----------
 f
(1 row)

-- extension: map item method
select _jsonpath_query(jsonb '1', 'strict $.map(@ + 10)');
ERROR:  SQL/JSON array not found
select _jsonpath_query(jsonb '1', 'lax $.map(@ + 10)');
 _jsonpath_query 
-----------------
 11
(1 row)

select _jsonpath_query(jsonb '[1, 2, 3]', '$.map(@ + 10)');
 _jsonpath_query 
-----------------
 [11, 12, 13]
(1 row)

select _jsonpath_query(jsonb '[[1, 2], [3, 4, 5], [], [6, 7]]', '$.map(@.map(@ + 10))');
            _jsonpath_query             
----------------------------------------
 [[11, 12], [13, 14, 15], [], [16, 17]]
(1 row)

-- extension: reduce/fold item methods
select _jsonpath_query(jsonb '1', 'strict $.reduce($1 + $2)');
ERROR:  SQL/JSON array not found
select _jsonpath_query(jsonb '1', 'lax $.reduce($1 + $2)');
 _jsonpath_query 
-----------------
 1
(1 row)

select _jsonpath_query(jsonb '1', 'strict $.fold($1 + $2, 10)');
ERROR:  SQL/JSON array not found
select _jsonpath_query(jsonb '1', 'lax $.fold($1 + $2, 10)');
 _jsonpath_query 
-----------------
 11
(1 row)

select _jsonpath_query(jsonb '[1, 2, 3]', '$.reduce($1 + $2)');
 _jsonpath_query 
-----------------
 6
(1 row)

select _jsonpath_query(jsonb '[1, 2, 3]', '$.fold($1 + $2, 100)');
 _jsonpath_query 
-----------------
 106
(1 row)

select _jsonpath_query(jsonb '[]', '$.reduce($1 + $2)');
 _jsonpath_query 
-----------------
(0 rows)

select _jsonpath_query(jsonb '[]', '$.fold($1 + $2, 100)');
 _jsonpath_query 
-----------------
 100
(1 row)

select _jsonpath_query(jsonb '[1]', '$.reduce($1 + $2)');
 _jsonpath_query 
-----------------
 1
(1 row)

select _jsonpath_query(jsonb '[1, 2, 3]', '$.foldl([$1, $2], [])');
  _jsonpath_query  
-------------------
 [[[[], 1], 2], 3]
(1 row)

select _jsonpath_query(jsonb '[1, 2, 3]', '$.foldr([$2, $1], [])');
  _jsonpath_query  
-------------------
 [[[[], 3], 2], 1]
(1 row)

select _jsonpath_query(jsonb '[[1, 2], [3, 4, 5], [], [6, 7]]', '$.fold($1 + $2.fold($1 + $2, 100), 1000)');
 _jsonpath_query 
-----------------
 1428
(1 row)

-- extension: path sequences
select _jsonpath_query(jsonb '[1,2,3,4,5]', '10, 20, $[*], 30');
 _jsonpath_query 
-----------------
 10
 20
 1
 2
 3
 4
 5
 30
(8 rows)

select _jsonpath_query(jsonb '[1,2,3,4,5]', 'lax    10, 20, $[*].a, 30');
 _jsonpath_query 
-----------------
 10
 20
 30
(3 rows)

select _jsonpath_query(jsonb '[1,2,3,4,5]', 'strict 10, 20, $[*].a, 30');
ERROR:  SQL/JSON member not found
select _jsonpath_query(jsonb '[1,2,3,4,5]', '-(10, 20, $[1 to 3], 30)');
 _jsonpath_query 
-----------------
 -10
 -20
 -2
 -3
 -4
 -30
(6 rows)

select _jsonpath_query(jsonb '[1,2,3,4,5]', 'lax (10, 20, $[1 to 3], 30).map(@ + 100)');
 _jsonpath_query 
-----------------
 110
 120
 102
 103
 104
 130
(6 rows)

select _jsonpath_query(jsonb '[1,2,3,4,5]', '$[(0, $[*], 5) ? (@ == 3)]');
 _jsonpath_query 
-----------------
 4
(1 row)

select _jsonpath_query(jsonb '[1,2,3,4,5]', '$[(0, $[*], 3) ? (@ == 3)]');
ERROR:  Invalid SQL/JSON subscript
-- extension: array constructors
select _jsonpath_query(jsonb '[1, 2, 3]', '[]');
 _jsonpath_query 
-----------------
 []
(1 row)

select _jsonpath_query(jsonb '[1, 2, 3]', '[1, 2, $.map(@ + 100)[*], 4, 5]');
       _jsonpath_query       
-----------------------------
 [1, 2, 101, 102, 103, 4, 5]
(1 row)

select _jsonpath_query(jsonb '[1, 2, 3]', '[1, 2, $.map(@ + 100)[*], 4, 5][*]');
 _jsonpath_query 
-----------------
 1
 2
 101
 102
 103
 4
 5
(7 rows)

select _jsonpath_query(jsonb '[1, 2, 3]', '[(1, (2, $.map(@ + 100)[*])), (4, 5)]');
       _jsonpath_query       
-----------------------------
 [1, 2, 101, 102, 103, 4, 5]
(1 row)

select _jsonpath_query(jsonb '[1, 2, 3]', '[[1, 2], [$.map(@ + 100)[*], 4], 5, [(1,2)?(@ > 5)]]');
           _jsonpath_query           
-------------------------------------
 [[1, 2], [101, 102, 103, 4], 5, []]
(1 row)

select _jsonpath_query(jsonb '[1, 2, 3]', 'strict [1, 2, $.map(@.a)[*], 4, 5]');
ERROR:  SQL/JSON member not found
select _jsonpath_query(jsonb '[[1, 2], [3, 4, 5], [], [6, 7]]', '[$[*].map(@ + 10)[*] ? (@ > 13)]');
 _jsonpath_query  
------------------
 [14, 15, 16, 17]
(1 row)

-- extension: object constructors
select _jsonpath_query(jsonb '[1, 2, 3]', '{}');
 _jsonpath_query 
-----------------
 {}
(1 row)

select _jsonpath_query(jsonb '[1, 2, 3]', '{a: 2 + 3, "b": [$[*], 4, 5]}');
        _jsonpath_query         
--------------------------------
 {"a": 5, "b": [1, 2, 3, 4, 5]}
(1 row)

select _jsonpath_query(jsonb '[1, 2, 3]', '{a: 2 + 3, "b": [$[*], 4, 5]}.*');
 _jsonpath_query 
-----------------
 5
 [1, 2, 3, 4, 5]
(2 rows)

select _jsonpath_query(jsonb '[1, 2, 3]', '{a: 2 + 3, "b": ($[*], 4, 5)}');
ERROR:  Singleton SQL/JSON item required
select _jsonpath_query(jsonb '[1, 2, 3]', '{a: 2 + 3, "b": [$.map({x: @, y: @ < 3})[*], {z: "foo"}]}');
                                        _jsonpath_query                                        
-----------------------------------------------------------------------------------------------
 {"a": 5, "b": [{"x": 1, "y": true}, {"x": 2, "y": true}, {"x": 3, "y": false}, {"z": "foo"}]}
(1 row)

