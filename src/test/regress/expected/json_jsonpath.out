select json '{"a": 12}' @? '$.a.b';
 ?column? 
----------
 f
(1 row)

select json '{"a": 12}' @? '$.b';
 ?column? 
----------
 f
(1 row)

select json '{"a": {"a": 12}}' @? '$.a.a';
 ?column? 
----------
 t
(1 row)

select json '{"a": {"a": 12}}' @? '$.*.a';
 ?column? 
----------
 t
(1 row)

select json '{"b": {"a": 12}}' @? '$.*.a';
 ?column? 
----------
 t
(1 row)

select json '{}' @? '$.*';
 ?column? 
----------
 f
(1 row)

select json '{"a": 1}' @? '$.*';
 ?column? 
----------
 t
(1 row)

select json '{"a": {"b": 1}}' @? 'lax $.**{1}';
 ?column? 
----------
 t
(1 row)

select json '{"a": {"b": 1}}' @? 'lax $.**{2}';
 ?column? 
----------
 t
(1 row)

select json '{"a": {"b": 1}}' @? 'lax $.**{3}';
 ?column? 
----------
 f
(1 row)

select json '[]' @? '$.[*]';
 ?column? 
----------
 f
(1 row)

select json '[1]' @? '$.[*]';
 ?column? 
----------
 t
(1 row)

select json '[1]' @? '$.[1]';
 ?column? 
----------
 f
(1 row)

select json '[1]' @? 'strict $.[1]';
ERROR:  Invalid SQL/JSON subscript
select json '[1]' @? '$.[0]';
 ?column? 
----------
 t
(1 row)

select json '[1]' @? '$.[0.3]';
 ?column? 
----------
 t
(1 row)

select json '[1]' @? '$.[0.5]';
 ?column? 
----------
 t
(1 row)

select json '[1]' @? '$.[0.9]';
 ?column? 
----------
 t
(1 row)

select json '[1]' @? '$.[1.2]';
 ?column? 
----------
 f
(1 row)

select json '[1]' @? 'strict $.[1.2]';
ERROR:  Invalid SQL/JSON subscript
select json '{}' @? 'strict $.[0.3]';
ERROR:  Invalid SQL/JSON subscript
select json '{}' @? 'lax $.[0.3]';
 ?column? 
----------
 t
(1 row)

select json '{}' @? 'strict $.[1.2]';
ERROR:  Invalid SQL/JSON subscript
select json '{}' @? 'lax $.[1.2]';
 ?column? 
----------
 f
(1 row)

select json '{}' @? 'strict $.[-2 to 3]';
ERROR:  Invalid SQL/JSON subscript
select json '{}' @? 'lax $.[-2 to 3]';
 ?column? 
----------
 t
(1 row)

select json '{"a": [1,2,3], "b": [3,4,5]}' @? '$ ? (@.a[*] >  @.b[*])';
 ?column? 
----------
 f
(1 row)

select json '{"a": [1,2,3], "b": [3,4,5]}' @? '$ ? (@.a[*] >= @.b[*])';
 ?column? 
----------
 t
(1 row)

select json '{"a": [1,2,3], "b": [3,4,"5"]}' @? '$ ? (@.a[*] >= @.b[*])';
 ?column? 
----------
 t
(1 row)

select json '{"a": [1,2,3], "b": [3,4,"5"]}' @? 'strict $ ? (@.a[*] >= @.b[*])';
 ?column? 
----------
 f
(1 row)

select json '{"a": [1,2,3], "b": [3,4,null]}' @? '$ ? (@.a[*] >= @.b[*])';
 ?column? 
----------
 t
(1 row)

select json '1' @? '$ ? ((@ == "1") is unknown)';
 ?column? 
----------
 t
(1 row)

select json '1' @? '$ ? ((@ == 1) is unknown)';
 ?column? 
----------
 f
(1 row)

select json '[{"a": 1}, {"a": 2}]' @? '$[0 to 1] ? (@.a > 1)';
 ?column? 
----------
 t
(1 row)

select json '{"a": 12, "b": {"a": 13}}' @* '$.a';
 ?column? 
----------
 12
(1 row)

select json '{"a": 12, "b": {"a": 13}}' @* '$.b';
 ?column?  
-----------
 {"a": 13}
(1 row)

select json '{"a": 12, "b": {"a": 13}}' @* '$.*';
 ?column?  
-----------
 12
 {"a": 13}
(2 rows)

select json '{"a": 12, "b": {"a": 13}}' @* 'lax $.*.a';
 ?column? 
----------
 13
(1 row)

select json '[12, {"a": 13}, {"b": 14}]' @* 'lax $.[*].a';
 ?column? 
----------
 13
(1 row)

select json '[12, {"a": 13}, {"b": 14}]' @* 'lax $.[*].*';
 ?column? 
----------
 13
 14
(2 rows)

select json '[12, {"a": 13}, {"b": 14}]' @* 'lax $.[0].a';
 ?column? 
----------
(0 rows)

select json '[12, {"a": 13}, {"b": 14}]' @* 'lax $.[1].a';
 ?column? 
----------
 13
(1 row)

select json '[12, {"a": 13}, {"b": 14}]' @* 'lax $.[2].a';
 ?column? 
----------
(0 rows)

select json '[12, {"a": 13}, {"b": 14}]' @* 'lax $.[0,1].a';
 ?column? 
----------
 13
(1 row)

select json '[12, {"a": 13}, {"b": 14}]' @* 'lax $.[0 to 10].a';
 ?column? 
----------
 13
(1 row)

select json '[12, {"a": 13}, {"b": 14}, "ccc", true]' @* '$.[2.5 - 1 to @.size() - 2]';
 ?column?  
-----------
 {"a": 13}
 {"b": 14}
 "ccc"
(3 rows)

select json '1' @* 'lax $[0]';
 ?column? 
----------
 1
(1 row)

select json '1' @* 'lax $[*]';
 ?column? 
----------
 1
(1 row)

select json '{}' @* 'lax $[0]';
 ?column? 
----------
 {}
(1 row)

select json '[1]' @* 'lax $[0]';
 ?column? 
----------
 1
(1 row)

select json '[1]' @* 'lax $[*]';
 ?column? 
----------
 1
(1 row)

select json '[1,2,3]' @* 'lax $[*]';
 ?column? 
----------
 1
 2
 3
(3 rows)

select json '[]' @* '$[last]';
 ?column? 
----------
(0 rows)

select json '[]' @* 'strict $[last]';
ERROR:  Invalid SQL/JSON subscript
select json '[1]' @* '$[last]';
 ?column? 
----------
 1
(1 row)

select json '{}' @* 'lax $[last]';
 ?column? 
----------
 {}
(1 row)

select json '[1,2,3]' @* '$[last]';
 ?column? 
----------
 3
(1 row)

select json '[1,2,3]' @* '$[last - 1]';
 ?column? 
----------
 2
(1 row)

select json '[1,2,3]' @* '$[last ? (@.type() == "number")]';
 ?column? 
----------
 3
(1 row)

select json '[1,2,3]' @* '$[last ? (@.type() == "string")]';
ERROR:  Invalid SQL/JSON subscript
select * from jsonpath_query(json '{"a": 10}', '$');
 jsonpath_query 
----------------
 {"a": 10}
(1 row)

select * from jsonpath_query(json '{"a": 10}', '$ ? (.a < $value)');
ERROR:  could not find 'value' passed variable
select * from jsonpath_query(json '{"a": 10}', '$ ? (.a < $value)', '{"value" : 13}');
 jsonpath_query 
----------------
 {"a": 10}
(1 row)

select * from jsonpath_query(json '{"a": 10}', '$ ? (.a < $value)', '{"value" : 8}');
 jsonpath_query 
----------------
(0 rows)

select * from jsonpath_query(json '{"a": 10}', '$.a ? (@ < $value)', '{"value" : 13}');
 jsonpath_query 
----------------
 10
(1 row)

select * from jsonpath_query(json '[10,11,12,13,14,15]', '$.[*] ? (@ < $value)', '{"value" : 13}');
 jsonpath_query 
----------------
 10
 11
 12
(3 rows)

select * from jsonpath_query(json '[10,11,12,13,14,15]', '$.[0,1] ? (@ < $value)', '{"value" : 13}');
 jsonpath_query 
----------------
 10
 11
(2 rows)

select * from jsonpath_query(json '[10,11,12,13,14,15]', '$.[0 to 2] ? (@ < $value)', '{"value" : 15}');
 jsonpath_query 
----------------
 10
 11
 12
(3 rows)

select * from jsonpath_query(json '[1,"1",2,"2",null]', '$.[*] ? (@ == "1")');
 jsonpath_query 
----------------
 "1"
(1 row)

select * from jsonpath_query(json '[1,"1",2,"2",null]', '$.[*] ? (@ == $value)', '{"value" : "1"}');
 jsonpath_query 
----------------
 "1"
(1 row)

select json '[1, "2", null]' @* '$[*] ? (@ != null)';
 ?column? 
----------
 1
 "2"
(2 rows)

select json '[1, "2", null]' @* '$[*] ? (@ == null)';
 ?column? 
----------
 null
(1 row)

select json '{"a": {"b": 1}}' @* 'lax $.**';
    ?column?     
-----------------
 {"a": {"b": 1}}
 {"b": 1}
 1
(3 rows)

select json '{"a": {"b": 1}}' @* 'lax $.**{1}';
 ?column? 
----------
 {"b": 1}
(1 row)

select json '{"a": {"b": 1}}' @* 'lax $.**{1,}';
 ?column? 
----------
 {"b": 1}
 1
(2 rows)

select json '{"a": {"b": 1}}' @* 'lax $.**{2}';
 ?column? 
----------
 1
(1 row)

select json '{"a": {"b": 1}}' @* 'lax $.**{2,}';
 ?column? 
----------
 1
(1 row)

select json '{"a": {"b": 1}}' @* 'lax $.**{3,}';
 ?column? 
----------
(0 rows)

select json '{"a": {"b": 1}}' @* 'lax $.**.b ? (@ > 0)';
 ?column? 
----------
 1
(1 row)

select json '{"a": {"b": 1}}' @* 'lax $.**{0}.b ? (@ > 0)';
 ?column? 
----------
(0 rows)

select json '{"a": {"b": 1}}' @* 'lax $.**{1}.b ? (@ > 0)';
 ?column? 
----------
 1
(1 row)

select json '{"a": {"b": 1}}' @* 'lax $.**{0,}.b ? (@ > 0)';
 ?column? 
----------
 1
(1 row)

select json '{"a": {"b": 1}}' @* 'lax $.**{1,}.b ? (@ > 0)';
 ?column? 
----------
 1
(1 row)

select json '{"a": {"b": 1}}' @* 'lax $.**{1,2}.b ? (@ > 0)';
 ?column? 
----------
 1
(1 row)

select json '{"a": {"c": {"b": 1}}}' @* 'lax $.**.b ? (@ > 0)';
 ?column? 
----------
 1
(1 row)

select json '{"a": {"c": {"b": 1}}}' @* 'lax $.**{0}.b ? (@ > 0)';
 ?column? 
----------
(0 rows)

select json '{"a": {"c": {"b": 1}}}' @* 'lax $.**{1}.b ? (@ > 0)';
 ?column? 
----------
(0 rows)

select json '{"a": {"c": {"b": 1}}}' @* 'lax $.**{0,}.b ? (@ > 0)';
 ?column? 
----------
 1
(1 row)

select json '{"a": {"c": {"b": 1}}}' @* 'lax $.**{1,}.b ? (@ > 0)';
 ?column? 
----------
 1
(1 row)

select json '{"a": {"c": {"b": 1}}}' @* 'lax $.**{1,2}.b ? (@ > 0)';
 ?column? 
----------
 1
(1 row)

select json '{"a": {"c": {"b": 1}}}' @* 'lax $.**{2,3}.b ? (@ > 0)';
 ?column? 
----------
 1
(1 row)

select json '{"a": {"b": 1}}' @? '$.**.b ? ( @ > 0)';
 ?column? 
----------
 t
(1 row)

select json '{"a": {"b": 1}}' @? '$.**{0}.b ? ( @ > 0)';
 ?column? 
----------
 f
(1 row)

select json '{"a": {"b": 1}}' @? '$.**{1}.b ? ( @ > 0)';
 ?column? 
----------
 t
(1 row)

select json '{"a": {"b": 1}}' @? '$.**{0,}.b ? ( @ > 0)';
 ?column? 
----------
 t
(1 row)

select json '{"a": {"b": 1}}' @? '$.**{1,}.b ? ( @ > 0)';
 ?column? 
----------
 t
(1 row)

select json '{"a": {"b": 1}}' @? '$.**{1,2}.b ? ( @ > 0)';
 ?column? 
----------
 t
(1 row)

select json '{"a": {"c": {"b": 1}}}' @? '$.**.b ? ( @ > 0)';
 ?column? 
----------
 t
(1 row)

select json '{"a": {"c": {"b": 1}}}' @? '$.**{0}.b ? ( @ > 0)';
 ?column? 
----------
 f
(1 row)

select json '{"a": {"c": {"b": 1}}}' @? '$.**{1}.b ? ( @ > 0)';
 ?column? 
----------
 f
(1 row)

select json '{"a": {"c": {"b": 1}}}' @? '$.**{0,}.b ? ( @ > 0)';
 ?column? 
----------
 t
(1 row)

select json '{"a": {"c": {"b": 1}}}' @? '$.**{1,}.b ? ( @ > 0)';
 ?column? 
----------
 t
(1 row)

select json '{"a": {"c": {"b": 1}}}' @? '$.**{1,2}.b ? ( @ > 0)';
 ?column? 
----------
 t
(1 row)

select json '{"a": {"c": {"b": 1}}}' @? '$.**{2,3}.b ? ( @ > 0)';
 ?column? 
----------
 t
(1 row)

select json '{"g": {"x": 2}}' @* '$.g ? (exists (@.x))';
 ?column? 
----------
 {"x": 2}
(1 row)

select json '{"g": {"x": 2}}' @* '$.g ? (exists (@.y))';
 ?column? 
----------
(0 rows)

select json '{"g": {"x": 2}}' @* '$.g ? (exists (@.x ? (@ >= 2) ))';
 ?column? 
----------
 {"x": 2}
(1 row)

--test ternary logic
select
	x, y,
	jsonpath_query(
		json '[true, false, null]',
		'$[*] ? (@ == true  &&  ($x == true && $y == true) ||
				 @ == false && !($x == true && $y == true) ||
				 @ == null  &&  ($x == true && $y == true) is unknown)',
		json_build_object('x', x, 'y', y)
	) as "x && y"
from
	(values (json 'true'), ('false'), ('"null"')) x(x),
	(values (json 'true'), ('false'), ('"null"')) y(y);
   x    |   y    | x && y 
--------+--------+--------
 true   | true   | true
 true   | false  | false
 true   | "null" | null
 false  | true   | false
 false  | false  | false
 false  | "null" | false
 "null" | true   | null
 "null" | false  | false
 "null" | "null" | null
(9 rows)

select
	x, y,
	jsonpath_query(
		json '[true, false, null]',
		'$[*] ? (@ == true  &&  ($x == true || $y == true) ||
				 @ == false && !($x == true || $y == true) ||
				 @ == null  &&  ($x == true || $y == true) is unknown)',
		json_build_object('x', x, 'y', y)
	) as "x || y"
from
	(values (json 'true'), ('false'), ('"null"')) x(x),
	(values (json 'true'), ('false'), ('"null"')) y(y);
   x    |   y    | x || y 
--------+--------+--------
 true   | true   | true
 true   | false  | true
 true   | "null" | true
 false  | true   | true
 false  | false  | false
 false  | "null" | null
 "null" | true   | true
 "null" | false  | null
 "null" | "null" | null
(9 rows)

select json '{"a": 1, "b": 1}' @? '$ ? (.a == .b)';
 ?column? 
----------
 t
(1 row)

select json '{"c": {"a": 1, "b": 1}}' @? '$ ? (.a == .b)';
 ?column? 
----------
 f
(1 row)

select json '{"c": {"a": 1, "b": 1}}' @? '$.c ? (.a == .b)';
 ?column? 
----------
 t
(1 row)

select json '{"c": {"a": 1, "b": 1}}' @? '$.c ? ($.c.a == .b)';
 ?column? 
----------
 t
(1 row)

select json '{"c": {"a": 1, "b": 1}}' @? '$.* ? (.a == .b)';
 ?column? 
----------
 t
(1 row)

select json '{"a": 1, "b": 1}' @? '$.** ? (.a == .b)';
 ?column? 
----------
 t
(1 row)

select json '{"c": {"a": 1, "b": 1}}' @? '$.** ? (.a == .b)';
 ?column? 
----------
 t
(1 row)

select json '{"c": {"a": 2, "b": 1}}' @* '$.** ? (.a == 1 + 1)';
     ?column?     
------------------
 {"a": 2, "b": 1}
(1 row)

select json '{"c": {"a": 2, "b": 1}}' @* '$.** ? (.a == (1 + 1))';
     ?column?     
------------------
 {"a": 2, "b": 1}
(1 row)

select json '{"c": {"a": 2, "b": 1}}' @* '$.** ? (.a == .b + 1)';
     ?column?     
------------------
 {"a": 2, "b": 1}
(1 row)

select json '{"c": {"a": 2, "b": 1}}' @* '$.** ? (.a == (.b + 1))';
     ?column?     
------------------
 {"a": 2, "b": 1}
(1 row)

select json '{"c": {"a": -1, "b": 1}}' @? '$.** ? (.a == - 1)';
 ?column? 
----------
 t
(1 row)

select json '{"c": {"a": -1, "b": 1}}' @? '$.** ? (.a == -1)';
 ?column? 
----------
 t
(1 row)

select json '{"c": {"a": -1, "b": 1}}' @? '$.** ? (.a == -.b)';
 ?column? 
----------
 t
(1 row)

select json '{"c": {"a": -1, "b": 1}}' @? '$.** ? (.a == - .b)';
 ?column? 
----------
 t
(1 row)

select json '{"c": {"a": 0, "b": 1}}' @? '$.** ? (.a == 1 - .b)';
 ?column? 
----------
 t
(1 row)

select json '{"c": {"a": 2, "b": 1}}' @? '$.** ? (.a == 1 - - .b)';
 ?column? 
----------
 t
(1 row)

select json '{"c": {"a": 0, "b": 1}}' @? '$.** ? (.a == 1 - +.b)';
 ?column? 
----------
 t
(1 row)

select json '[1,2,3]' @? '$ ? (+@[*] > +2)';
 ?column? 
----------
 t
(1 row)

select json '[1,2,3]' @? '$ ? (+@[*] > +3)';
 ?column? 
----------
 f
(1 row)

select json '[1,2,3]' @? '$ ? (-@[*] < -2)';
 ?column? 
----------
 t
(1 row)

select json '[1,2,3]' @? '$ ? (-@[*] < -3)';
 ?column? 
----------
 f
(1 row)

select json '1' @? '$ ? ($ > 0)';
 ?column? 
----------
 t
(1 row)

-- unwrapping of operator arguments in lax mode
select json '{"a": [2]}' @* 'lax $.a * 3';
 ?column? 
----------
 6
(1 row)

select json '{"a": [2]}' @* 'lax $.a + 3';
 ?column? 
----------
 5
(1 row)

select json '{"a": [2, 3, 4]}' @* 'lax -$.a';
 ?column? 
----------
 -2
 -3
 -4
(3 rows)

-- should fail
select json '{"a": [1, 2]}' @* 'lax $.a * 3';
ERROR:  Singleton SQL/JSON item required
-- extension: boolean expressions
select json '2' @* '$ > 1';
 ?column? 
----------
 true
(1 row)

select json '2' @* '$ <= 1';
 ?column? 
----------
 false
(1 row)

select json '2' @* '$ == "2"';
 ?column? 
----------
 null
(1 row)

select json '2' @~ '$ > 1';
 ?column? 
----------
 t
(1 row)

select json '2' @~ '$ <= 1';
 ?column? 
----------
 f
(1 row)

select json '2' @~ '$ == "2"';
 ?column? 
----------
 
(1 row)

select json '2' @~ '1';
 ?column? 
----------
 
(1 row)

select json '{}' @~ '$';
 ?column? 
----------
 
(1 row)

select json '[]' @~ '$';
 ?column? 
----------
 
(1 row)

select json '[1,2,3]' @~ '$[*]';
ERROR:  Singleton SQL/JSON item required
select json '[]' @~ '$[*]';
ERROR:  Singleton SQL/JSON item required
select jsonpath_predicate(json '[[1, true], [2, false]]', 'strict $[*] ? (@[0] > $x) [1]', '{"x": 1}');
 jsonpath_predicate 
--------------------
 f
(1 row)

select jsonpath_predicate(json '[[1, true], [2, false]]', 'strict $[*] ? (@[0] < $x) [1]', '{"x": 2}');
 jsonpath_predicate 
--------------------
 t
(1 row)

select json '[null,1,true,"a",[],{}]' @* '$.type()';
 ?column? 
----------
 "array"
(1 row)

select json '[null,1,true,"a",[],{}]' @* 'lax $.type()';
 ?column? 
----------
 "array"
(1 row)

select json '[null,1,true,"a",[],{}]' @* '$[*].type()';
 ?column?  
-----------
 "null"
 "number"
 "boolean"
 "string"
 "array"
 "object"
(6 rows)

select json 'null' @* 'null.type()';
 ?column? 
----------
 "null"
(1 row)

select json 'null' @* 'true.type()';
 ?column?  
-----------
 "boolean"
(1 row)

select json 'null' @* '123.type()';
 ?column? 
----------
 "number"
(1 row)

select json 'null' @* '"123".type()';
 ?column? 
----------
 "string"
(1 row)

select json '{"a": 2}' @* '($.a - 5).abs() + 10';
 ?column? 
----------
 13
(1 row)

select json '{"a": 2.5}' @* '-($.a * $.a).floor() + 10';
 ?column? 
----------
 4
(1 row)

select json '[1, 2, 3]' @* '($[*] > 2) ? (@ == true)';
 ?column? 
----------
 true
(1 row)

select json '[1, 2, 3]' @* '($[*] > 3).type()';
 ?column?  
-----------
 "boolean"
(1 row)

select json '[1, 2, 3]' @* '($[*].a > 3).type()';
 ?column?  
-----------
 "boolean"
(1 row)

select json '[1, 2, 3]' @* 'strict ($[*].a > 3).type()';
 ?column? 
----------
 "null"
(1 row)

select json '[1,null,true,"11",[],[1],[1,2,3],{},{"a":1,"b":2}]' @* 'strict $[*].size()';
ERROR:  SQL/JSON array not found
select json '[1,null,true,"11",[],[1],[1,2,3],{},{"a":1,"b":2}]' @* 'lax $[*].size()';
 ?column? 
----------
 1
 1
 1
 1
 0
 1
 3
 1
 1
(9 rows)

select json '[0, 1, -2, -3.4, 5.6]' @* '$[*].abs()';
 ?column? 
----------
 0
 1
 2
 3.4
 5.6
(5 rows)

select json '[0, 1, -2, -3.4, 5.6]' @* '$[*].floor()';
 ?column? 
----------
 0
 1
 -2
 -4
 5
(5 rows)

select json '[0, 1, -2, -3.4, 5.6]' @* '$[*].ceiling()';
 ?column? 
----------
 0
 1
 -2
 -3
 6
(5 rows)

select json '[0, 1, -2, -3.4, 5.6]' @* '$[*].ceiling().abs()';
 ?column? 
----------
 0
 1
 2
 3
 6
(5 rows)

select json '[0, 1, -2, -3.4, 5.6]' @* '$[*].ceiling().abs().type()';
 ?column? 
----------
 "number"
 "number"
 "number"
 "number"
 "number"
(5 rows)

select json '[{},1]' @* '$[*].keyvalue()';
ERROR:  SQL/JSON object not found
select json '{}' @* '$.keyvalue()';
 ?column? 
----------
(0 rows)

select json '{"a": 1, "b": [1, 2], "c": {"a": "bbb"}}' @* '$.keyvalue()';
              ?column?               
-------------------------------------
 {"key": "a", "value": 1}
 {"key": "b", "value": [1, 2]}
 {"key": "c", "value": {"a": "bbb"}}
(3 rows)

select json '[{"a": 1, "b": [1, 2]}, {"c": {"a": "bbb"}}]' @* '$[*].keyvalue()';
              ?column?               
-------------------------------------
 {"key": "a", "value": 1}
 {"key": "b", "value": [1, 2]}
 {"key": "c", "value": {"a": "bbb"}}
(3 rows)

select json '[{"a": 1, "b": [1, 2]}, {"c": {"a": "bbb"}}]' @* 'strict $.keyvalue()';
ERROR:  SQL/JSON object not found
select json '[{"a": 1, "b": [1, 2]}, {"c": {"a": "bbb"}}]' @* 'lax $.keyvalue()';
              ?column?               
-------------------------------------
 {"key": "a", "value": 1}
 {"key": "b", "value": [1, 2]}
 {"key": "c", "value": {"a": "bbb"}}
(3 rows)

select json 'null' @* '$.double()';
ERROR:  Non-numeric SQL/JSON item
select json 'true' @* '$.double()';
ERROR:  Non-numeric SQL/JSON item
select json '[]' @* '$.double()';
 ?column? 
----------
(0 rows)

select json '[]' @* 'strict $.double()';
ERROR:  Non-numeric SQL/JSON item
select json '{}' @* '$.double()';
ERROR:  Non-numeric SQL/JSON item
select json '1.23' @* '$.double()';
 ?column? 
----------
 1.23
(1 row)

select json '"1.23"' @* '$.double()';
 ?column? 
----------
 1.23
(1 row)

select json '"1.23aaa"' @* '$.double()';
ERROR:  Non-numeric SQL/JSON item
select json '["", "a", "abc", "abcabc"]' @* '$[*] ? (@ starts with "abc")';
 ?column? 
----------
 "abc"
 "abcabc"
(2 rows)

select json '["", "a", "abc", "abcabc"]' @* 'strict $ ? (@[*] starts with "abc")';
          ?column?          
----------------------------
 ["", "a", "abc", "abcabc"]
(1 row)

select json '["", "a", "abd", "abdabc"]' @* 'strict $ ? (@[*] starts with "abc")';
 ?column? 
----------
(0 rows)

select json '["abc", "abcabc", null, 1]' @* 'strict $ ? (@[*] starts with "abc")';
 ?column? 
----------
(0 rows)

select json '["abc", "abcabc", null, 1]' @* 'strict $ ? ((@[*] starts with "abc") is unknown)';
          ?column?          
----------------------------
 ["abc", "abcabc", null, 1]
(1 row)

select json '[[null, 1, "abc", "abcabc"]]' @* 'lax $ ? (@[*] starts with "abc")';
          ?column?          
----------------------------
 [null, 1, "abc", "abcabc"]
(1 row)

select json '[[null, 1, "abd", "abdabc"]]' @* 'lax $ ? ((@[*] starts with "abc") is unknown)';
          ?column?          
----------------------------
 [null, 1, "abd", "abdabc"]
(1 row)

select json '[null, 1, "abd", "abdabc"]' @* 'lax $[*] ? ((@ starts with "abc") is unknown)';
 ?column? 
----------
 null
 1
(2 rows)

select json '[null, 1, "abc", "abd", "aBdC", "abdacb", "babc"]' @* 'lax $[*] ? (@ like_regex "^ab.*c")';
 ?column? 
----------
 "abc"
 "abdacb"
(2 rows)

select json '[null, 1, "abc", "abd", "aBdC", "abdacb", "babc"]' @* 'lax $[*] ? (@ like_regex "^ab.*c" flag "i")';
 ?column? 
----------
 "abc"
 "aBdC"
 "abdacb"
(3 rows)

select json 'null' @* '$.datetime()';
ERROR:  Invalid argument for SQL/JSON datetime function
select json 'true' @* '$.datetime()';
ERROR:  Invalid argument for SQL/JSON datetime function
select json '[]' @* '$.datetime()';
 ?column? 
----------
(0 rows)

select json '[]' @* 'strict $.datetime()';
ERROR:  Invalid argument for SQL/JSON datetime function
select json '{}' @* '$.datetime()';
ERROR:  Invalid argument for SQL/JSON datetime function
select json '""' @* '$.datetime()';
ERROR:  Invalid argument for SQL/JSON datetime function
-- Standard extension: UNIX epoch to timestamptz
select json '0' @* '$.datetime()';
            ?column?            
--------------------------------
 "Wed Dec 31 16:00:00 1969 PST"
(1 row)

select json '0' @* '$.datetime().type()';
          ?column?          
----------------------------
 "timestamp with time zone"
(1 row)

select json '1490216035.5' @* '$.datetime()';
             ?column?             
----------------------------------
 "Wed Mar 22 13:53:55.5 2017 PDT"
(1 row)

select json '"10-03-2017"' @*       '$.datetime("dd-mm-yyyy")';
   ?column?   
--------------
 "03-10-2017"
(1 row)

select json '"10-03-2017"' @*       '$.datetime("dd-mm-yyyy").type()';
 ?column? 
----------
 "date"
(1 row)

select json '"10-03-2017 12:34"' @* '$.datetime("dd-mm-yyyy")';
   ?column?   
--------------
 "03-10-2017"
(1 row)

select json '"10-03-2017 12:34"' @* '$.datetime("dd-mm-yyyy").type()';
 ?column? 
----------
 "date"
(1 row)

select json '"10-03-2017 12:34"' @* '       $.datetime("dd-mm-yyyy HH24:MI").type()';
           ?column?            
-------------------------------
 "timestamp without time zone"
(1 row)

select json '"10-03-2017 12:34 +05:20"' @* '$.datetime("dd-mm-yyyy HH24:MI TZH:TZM").type()';
          ?column?          
----------------------------
 "timestamp with time zone"
(1 row)

select json '"12:34:56"' @*                '$.datetime("HH24:MI:SS").type()';
         ?column?         
--------------------------
 "time without time zone"
(1 row)

select json '"12:34:56 +05:20"' @*         '$.datetime("HH24:MI:SS TZH:TZM").type()';
       ?column?        
-----------------------
 "time with time zone"
(1 row)

set time zone '+00';
select json '"10-03-2017 12:34"' @*        '$.datetime("dd-mm-yyyy HH24:MI")';
          ?column?          
----------------------------
 "Fri Mar 10 12:34:00 2017"
(1 row)

select json '"10-03-2017 12:34"' @*        '$.datetime("dd-mm-yyyy HH24:MI TZH")';
            ?column?            
--------------------------------
 "Fri Mar 10 12:34:00 2017 +00"
(1 row)

select json '"10-03-2017 12:34 +05"' @*    '$.datetime("dd-mm-yyyy HH24:MI TZH")';
            ?column?            
--------------------------------
 "Fri Mar 10 07:34:00 2017 +00"
(1 row)

select json '"10-03-2017 12:34 -05"' @*    '$.datetime("dd-mm-yyyy HH24:MI TZH")';
            ?column?            
--------------------------------
 "Fri Mar 10 17:34:00 2017 +00"
(1 row)

select json '"10-03-2017 12:34 +05:20"' @* '$.datetime("dd-mm-yyyy HH24:MI TZH:TZM")';
            ?column?            
--------------------------------
 "Fri Mar 10 07:14:00 2017 +00"
(1 row)

select json '"10-03-2017 12:34 -05:20"' @* '$.datetime("dd-mm-yyyy HH24:MI TZH:TZM")';
            ?column?            
--------------------------------
 "Fri Mar 10 17:54:00 2017 +00"
(1 row)

select json '"12:34"' @*       '$.datetime("HH24:MI")';
  ?column?  
------------
 "12:34:00"
(1 row)

select json '"12:34"' @*       '$.datetime("HH24:MI TZH")';
   ?column?    
---------------
 "12:34:00+00"
(1 row)

select json '"12:34 +05"' @*    '$.datetime("HH24:MI TZH")';
   ?column?    
---------------
 "12:34:00+05"
(1 row)

select json '"12:34 -05"' @*    '$.datetime("HH24:MI TZH")';
   ?column?    
---------------
 "12:34:00-05"
(1 row)

select json '"12:34 +05:20"' @* '$.datetime("HH24:MI TZH:TZM")';
     ?column?     
------------------
 "12:34:00+05:20"
(1 row)

select json '"12:34 -05:20"' @* '$.datetime("HH24:MI TZH:TZM")';
     ?column?     
------------------
 "12:34:00-05:20"
(1 row)

set time zone '+10';
select json '"10-03-2017 12:34"' @*        '$.datetime("dd-mm-yyyy HH24:MI")';
          ?column?          
----------------------------
 "Fri Mar 10 12:34:00 2017"
(1 row)

select json '"10-03-2017 12:34"' @*        '$.datetime("dd-mm-yyyy HH24:MI TZH")';
            ?column?            
--------------------------------
 "Fri Mar 10 12:34:00 2017 +10"
(1 row)

select json '"10-03-2017 12:34 +05"' @*    '$.datetime("dd-mm-yyyy HH24:MI TZH")';
            ?column?            
--------------------------------
 "Fri Mar 10 17:34:00 2017 +10"
(1 row)

select json '"10-03-2017 12:34 -05"' @*    '$.datetime("dd-mm-yyyy HH24:MI TZH")';
            ?column?            
--------------------------------
 "Sat Mar 11 03:34:00 2017 +10"
(1 row)

select json '"10-03-2017 12:34 +05:20"' @* '$.datetime("dd-mm-yyyy HH24:MI TZH:TZM")';
            ?column?            
--------------------------------
 "Fri Mar 10 17:14:00 2017 +10"
(1 row)

select json '"10-03-2017 12:34 -05:20"' @* '$.datetime("dd-mm-yyyy HH24:MI TZH:TZM")';
            ?column?            
--------------------------------
 "Sat Mar 11 03:54:00 2017 +10"
(1 row)

select json '"12:34"' @*        '$.datetime("HH24:MI")';
  ?column?  
------------
 "12:34:00"
(1 row)

select json '"12:34"' @*        '$.datetime("HH24:MI TZH")';
   ?column?    
---------------
 "12:34:00+10"
(1 row)

select json '"12:34 +05"' @*    '$.datetime("HH24:MI TZH")';
   ?column?    
---------------
 "12:34:00+05"
(1 row)

select json '"12:34 -05"' @*    '$.datetime("HH24:MI TZH")';
   ?column?    
---------------
 "12:34:00-05"
(1 row)

select json '"12:34 +05:20"' @* '$.datetime("HH24:MI TZH:TZM")';
     ?column?     
------------------
 "12:34:00+05:20"
(1 row)

select json '"12:34 -05:20"' @* '$.datetime("HH24:MI TZH:TZM")';
     ?column?     
------------------
 "12:34:00-05:20"
(1 row)

set time zone default;
select json '"2017-03-10"' @* '$.datetime().type()';
 ?column? 
----------
 "date"
(1 row)

select json '"2017-03-10"' @* '$.datetime()';
   ?column?   
--------------
 "03-10-2017"
(1 row)

select json '"2017-03-10 12:34:56"' @* '$.datetime().type()';
           ?column?            
-------------------------------
 "timestamp without time zone"
(1 row)

select json '"2017-03-10 12:34:56"' @* '$.datetime()';
          ?column?          
----------------------------
 "Fri Mar 10 12:34:56 2017"
(1 row)

select json '"2017-03-10 12:34:56 +3"' @* '$.datetime().type()';
          ?column?          
----------------------------
 "timestamp with time zone"
(1 row)

select json '"2017-03-10 12:34:56 +3"' @* '$.datetime()';
            ?column?            
--------------------------------
 "Fri Mar 10 01:34:56 2017 PST"
(1 row)

select json '"2017-03-10 12:34:56 +3:10"' @* '$.datetime().type()';
          ?column?          
----------------------------
 "timestamp with time zone"
(1 row)

select json '"2017-03-10 12:34:56 +3:10"' @* '$.datetime()';
            ?column?            
--------------------------------
 "Fri Mar 10 01:24:56 2017 PST"
(1 row)

select json '"12:34:56"' @* '$.datetime().type()';
         ?column?         
--------------------------
 "time without time zone"
(1 row)

select json '"12:34:56"' @* '$.datetime()';
  ?column?  
------------
 "12:34:56"
(1 row)

select json '"12:34:56 +3"' @* '$.datetime().type()';
       ?column?        
-----------------------
 "time with time zone"
(1 row)

select json '"12:34:56 +3"' @* '$.datetime()';
   ?column?    
---------------
 "12:34:56+03"
(1 row)

select json '"12:34:56 +3:10"' @* '$.datetime().type()';
       ?column?        
-----------------------
 "time with time zone"
(1 row)

select json '"12:34:56 +3:10"' @* '$.datetime()';
     ?column?     
------------------
 "12:34:56+03:10"
(1 row)

set time zone '+00';
-- date comparison
select json '["2017-03-10", "2017-03-11", "2017-03-09", "12:34:56", "01:02:03 +04", "2017-03-10 00:00:00", "2017-03-10 12:34:56", "2017-03-10 01:02:03 +04", "2017-03-10 03:00:00 +03"]'
	@* '$[*].datetime() ? (@ == "10.03.2017".datetime("dd.mm.yyyy"))';
            ?column?            
--------------------------------
 "03-10-2017"
 "Fri Mar 10 00:00:00 2017"
 "Fri Mar 10 00:00:00 2017 +00"
(3 rows)

select json '["2017-03-10", "2017-03-11", "2017-03-09", "12:34:56", "01:02:03 +04", "2017-03-10 00:00:00", "2017-03-10 12:34:56", "2017-03-10 01:02:03 +04", "2017-03-10 03:00:00 +03"]'
	@* '$[*].datetime() ? (@ >= "10.03.2017".datetime("dd.mm.yyyy"))';
            ?column?            
--------------------------------
 "03-10-2017"
 "03-11-2017"
 "Fri Mar 10 00:00:00 2017"
 "Fri Mar 10 12:34:56 2017"
 "Fri Mar 10 00:00:00 2017 +00"
(5 rows)

select json '["2017-03-10", "2017-03-11", "2017-03-09", "12:34:56", "01:02:03 +04", "2017-03-10 00:00:00", "2017-03-10 12:34:56", "2017-03-10 01:02:03 +04", "2017-03-10 03:00:00 +03"]'
	@* '$[*].datetime() ? (@ <  "10.03.2017".datetime("dd.mm.yyyy"))';
            ?column?            
--------------------------------
 "03-09-2017"
 "Thu Mar 09 21:02:03 2017 +00"
(2 rows)

-- time comparison
select json '["12:34:00", "12:35:00", "12:36:00", "12:35:00 +00", "12:35:00 +01", "13:35:00 +01", "2017-03-10", "2017-03-10 12:35:00", "2017-03-10 12:35:00 +01"]'
	@* '$[*].datetime() ? (@ == "12:35".datetime("HH24:MI"))';
   ?column?    
---------------
 "12:35:00"
 "12:35:00+00"
(2 rows)

select json '["12:34:00", "12:35:00", "12:36:00", "12:35:00 +00", "12:35:00 +01", "13:35:00 +01", "2017-03-10", "2017-03-10 12:35:00", "2017-03-10 12:35:00 +01"]'
	@* '$[*].datetime() ? (@ >= "12:35".datetime("HH24:MI"))';
   ?column?    
---------------
 "12:35:00"
 "12:36:00"
 "12:35:00+00"
(3 rows)

select json '["12:34:00", "12:35:00", "12:36:00", "12:35:00 +00", "12:35:00 +01", "13:35:00 +01", "2017-03-10", "2017-03-10 12:35:00", "2017-03-10 12:35:00 +01"]'
	@* '$[*].datetime() ? (@ <  "12:35".datetime("HH24:MI"))';
   ?column?    
---------------
 "12:34:00"
 "12:35:00+01"
 "13:35:00+01"
(3 rows)

-- timetz comparison
select json '["12:34:00 +01", "12:35:00 +01", "12:36:00 +01", "12:35:00 +02", "12:35:00 -02", "10:35:00", "11:35:00", "12:35:00", "2017-03-10", "2017-03-10 12:35:00", "2017-03-10 12:35:00 +1"]'
	@* '$[*].datetime() ? (@ == "12:35 +1".datetime("HH24:MI TZH"))';
   ?column?    
---------------
 "12:35:00+01"
(1 row)

select json '["12:34:00 +01", "12:35:00 +01", "12:36:00 +01", "12:35:00 +02", "12:35:00 -02", "10:35:00", "11:35:00", "12:35:00", "2017-03-10", "2017-03-10 12:35:00", "2017-03-10 12:35:00 +1"]'
	@* '$[*].datetime() ? (@ >= "12:35 +1".datetime("HH24:MI TZH"))';
   ?column?    
---------------
 "12:35:00+01"
 "12:36:00+01"
 "12:35:00-02"
 "11:35:00"
 "12:35:00"
(5 rows)

select json '["12:34:00 +01", "12:35:00 +01", "12:36:00 +01", "12:35:00 +02", "12:35:00 -02", "10:35:00", "11:35:00", "12:35:00", "2017-03-10", "2017-03-10 12:35:00", "2017-03-10 12:35:00 +1"]'
	@* '$[*].datetime() ? (@ <  "12:35 +1".datetime("HH24:MI TZH"))';
   ?column?    
---------------
 "12:34:00+01"
 "12:35:00+02"
 "10:35:00"
(3 rows)

-- timestamp comparison
select json '["2017-03-10 12:34:00", "2017-03-10 12:35:00", "2017-03-10 12:36:00", "2017-03-10 12:35:00 +01", "2017-03-10 13:35:00 +01", "2017-03-10 12:35:00 -01", "2017-03-10", "2017-03-11", "12:34:56", "12:34:56 +01"]'
	@* '$[*].datetime() ? (@ == "10.03.2017 12:35".datetime("dd.mm.yyyy HH24:MI"))';
            ?column?            
--------------------------------
 "Fri Mar 10 12:35:00 2017"
 "Fri Mar 10 12:35:00 2017 +00"
(2 rows)

select json '["2017-03-10 12:34:00", "2017-03-10 12:35:00", "2017-03-10 12:36:00", "2017-03-10 12:35:00 +01", "2017-03-10 13:35:00 +01", "2017-03-10 12:35:00 -01", "2017-03-10", "2017-03-11", "12:34:56", "12:34:56 +01"]'
	@* '$[*].datetime() ? (@ >= "10.03.2017 12:35".datetime("dd.mm.yyyy HH24:MI"))';
            ?column?            
--------------------------------
 "Fri Mar 10 12:35:00 2017"
 "Fri Mar 10 12:36:00 2017"
 "Fri Mar 10 12:35:00 2017 +00"
 "Fri Mar 10 13:35:00 2017 +00"
 "03-11-2017"
(5 rows)

select json '["2017-03-10 12:34:00", "2017-03-10 12:35:00", "2017-03-10 12:36:00", "2017-03-10 12:35:00 +01", "2017-03-10 13:35:00 +01", "2017-03-10 12:35:00 -01", "2017-03-10", "2017-03-11", "12:34:56", "12:34:56 +01"]'
	@* '$[*].datetime() ? (@ < "10.03.2017 12:35".datetime("dd.mm.yyyy HH24:MI"))';
            ?column?            
--------------------------------
 "Fri Mar 10 12:34:00 2017"
 "Fri Mar 10 11:35:00 2017 +00"
 "03-10-2017"
(3 rows)

-- timestamptz comparison
select json '["2017-03-10 12:34:00 +01", "2017-03-10 12:35:00 +01", "2017-03-10 12:36:00 +01", "2017-03-10 12:35:00 +02", "2017-03-10 12:35:00 -02", "2017-03-10 10:35:00", "2017-03-10 11:35:00", "2017-03-10 12:35:00", "2017-03-10", "2017-03-11", "12:34:56", "12:34:56 +01"]'
	@* '$[*].datetime() ? (@ == "10.03.2017 12:35 +1".datetime("dd.mm.yyyy HH24:MI TZH"))';
            ?column?            
--------------------------------
 "Fri Mar 10 11:35:00 2017 +00"
 "Fri Mar 10 11:35:00 2017"
(2 rows)

select json '["2017-03-10 12:34:00 +01", "2017-03-10 12:35:00 +01", "2017-03-10 12:36:00 +01", "2017-03-10 12:35:00 +02", "2017-03-10 12:35:00 -02", "2017-03-10 10:35:00", "2017-03-10 11:35:00", "2017-03-10 12:35:00", "2017-03-10", "2017-03-11", "12:34:56", "12:34:56 +01"]'
	@* '$[*].datetime() ? (@ >= "10.03.2017 12:35 +1".datetime("dd.mm.yyyy HH24:MI TZH"))';
            ?column?            
--------------------------------
 "Fri Mar 10 11:35:00 2017 +00"
 "Fri Mar 10 11:36:00 2017 +00"
 "Fri Mar 10 14:35:00 2017 +00"
 "Fri Mar 10 11:35:00 2017"
 "Fri Mar 10 12:35:00 2017"
 "03-11-2017"
(6 rows)

select json '["2017-03-10 12:34:00 +01", "2017-03-10 12:35:00 +01", "2017-03-10 12:36:00 +01", "2017-03-10 12:35:00 +02", "2017-03-10 12:35:00 -02", "2017-03-10 10:35:00", "2017-03-10 11:35:00", "2017-03-10 12:35:00", "2017-03-10", "2017-03-11", "12:34:56", "12:34:56 +01"]'
	@* '$[*].datetime() ? (@ < "10.03.2017 12:35 +1".datetime("dd.mm.yyyy HH24:MI TZH"))';
            ?column?            
--------------------------------
 "Fri Mar 10 11:34:00 2017 +00"
 "Fri Mar 10 10:35:00 2017 +00"
 "Fri Mar 10 10:35:00 2017"
 "03-10-2017"
(4 rows)

set time zone default;
-- jsonpath operators
SELECT json '[{"a": 1}, {"a": 2}]' @* '$[*]';
 ?column? 
----------
 {"a": 1}
 {"a": 2}
(2 rows)

SELECT json '[{"a": 1}, {"a": 2}]' @* '$[*] ? (@.a > 10)';
 ?column? 
----------
(0 rows)

SELECT json '[{"a": 1}, {"a": 2}]' @* '[$[*].a]';
 ?column? 
----------
 [1, 2]
(1 row)

SELECT json '[{"a": 1}, {"a": 2}]' @? '$[*] ? (@.a > 1)';
 ?column? 
----------
 t
(1 row)

SELECT json '[{"a": 1}, {"a": 2}]' @? '$[*].a ? (@ > 2)';
 ?column? 
----------
 f
(1 row)

SELECT json '[{"a": 1}, {"a": 2}]' @~ '$[*].a > 1';
 ?column? 
----------
 t
(1 row)

SELECT json '[{"a": 1}, {"a": 2}]' @~ '$[*].a > 2';
 ?column? 
----------
 f
(1 row)

-- extension: map item method
select json '1' @* 'strict $.map(@ + 10)';
ERROR:  SQL/JSON array not found
select json '1' @* 'lax $.map(@ + 10)';
 ?column? 
----------
 11
(1 row)

select json '[1, 2, 3]' @* '$.map(@ + 10)';
   ?column?   
--------------
 [11, 12, 13]
(1 row)

select json '[[1, 2], [3, 4, 5], [], [6, 7]]' @* '$.map(@.map(@ + 10))';
                ?column?                
----------------------------------------
 [[11, 12], [13, 14, 15], [], [16, 17]]
(1 row)

-- extension: reduce/fold item methods
select json '1' @* 'strict $.reduce($1 + $2)';
ERROR:  SQL/JSON array not found
select json '1' @* 'lax $.reduce($1 + $2)';
 ?column? 
----------
 1
(1 row)

select json '1' @* 'strict $.fold($1 + $2, 10)';
ERROR:  SQL/JSON array not found
select json '1' @* 'lax $.fold($1 + $2, 10)';
 ?column? 
----------
 11
(1 row)

select json '[1, 2, 3]' @* '$.reduce($1 + $2)';
 ?column? 
----------
 6
(1 row)

select json '[1, 2, 3]' @* '$.fold($1 + $2, 100)';
 ?column? 
----------
 106
(1 row)

select json '[]' @* '$.reduce($1 + $2)';
 ?column? 
----------
(0 rows)

select json '[]' @* '$.fold($1 + $2, 100)';
 ?column? 
----------
 100
(1 row)

select json '[1]' @* '$.reduce($1 + $2)';
 ?column? 
----------
 1
(1 row)

select json '[1, 2, 3]' @* '$.foldl([$1, $2], [])';
     ?column?      
-------------------
 [[[[], 1], 2], 3]
(1 row)

select json '[1, 2, 3]' @* '$.foldr([$2, $1], [])';
     ?column?      
-------------------
 [[[[], 3], 2], 1]
(1 row)

select json '[[1, 2], [3, 4, 5], [], [6, 7]]' @* '$.fold($1 + $2.fold($1 + $2, 100), 1000)';
 ?column? 
----------
 1428
(1 row)

-- extension: min/max item methods
select json '1' @* 'strict $.min()';
ERROR:  SQL/JSON array not found
select json '1' @* 'lax $.min()';
 ?column? 
----------
 1
(1 row)

select json '[]' @* '$.min()';
 ?column? 
----------
(0 rows)

select json '[]' @* '$.max()';
 ?column? 
----------
(0 rows)

select json '[null]' @* '$.min()';
 ?column? 
----------
 null
(1 row)

select json '[null]' @* '$.max()';
 ?column? 
----------
 null
(1 row)

select json '[1, 2, 3]' @* '$.min()';
 ?column? 
----------
 1
(1 row)

select json '[1, 2, 3]' @* '$.max()';
 ?column? 
----------
 3
(1 row)

select json '[2, 3, 5, null, 1, 4, null]' @* '$.min()';
 ?column? 
----------
 1
(1 row)

select json '[2, 3, 5, null, 1, 4, null]' @* '$.max()';
 ?column? 
----------
 5
(1 row)

select json '["aa", null, "a", "bbb"]' @* '$.min()';
 ?column? 
----------
 "a"
(1 row)

select json '["aa", null, "a", "bbb"]' @* '$.max()';
 ?column? 
----------
 "bbb"
(1 row)

select json '[1, null, "2"]' @* '$.max()';
ERROR:  SQL/JSON scalar required
-- extension: path sequences
select json '[1,2,3,4,5]' @* '10, 20, $[*], 30';
 ?column? 
----------
 10
 20
 1
 2
 3
 4
 5
 30
(8 rows)

select json '[1,2,3,4,5]' @* 'lax    10, 20, $[*].a, 30';
 ?column? 
----------
 10
 20
 30
(3 rows)

select json '[1,2,3,4,5]' @* 'strict 10, 20, $[*].a, 30';
ERROR:  SQL/JSON member not found
select json '[1,2,3,4,5]' @* '-(10, 20, $[1 to 3], 30)';
 ?column? 
----------
 -10
 -20
 -2
 -3
 -4
 -30
(6 rows)

select json '[1,2,3,4,5]' @* 'lax (10, 20, $[1 to 3], 30).map(@ + 100)';
 ?column? 
----------
 110
 120
 102
 103
 104
 130
(6 rows)

select json '[1,2,3,4,5]' @* '$[(0, $[*], 5) ? (@ == 3)]';
 ?column? 
----------
 4
(1 row)

select json '[1,2,3,4,5]' @* '$[(0, $[*], 3) ? (@ == 3)]';
ERROR:  Invalid SQL/JSON subscript
-- extension: array constructors
select json '[1, 2, 3]' @* '[]';
 ?column? 
----------
 []
(1 row)

select json '[1, 2, 3]' @* '[1, 2, $.map(@ + 100)[*], 4, 5]';
          ?column?           
-----------------------------
 [1, 2, 101, 102, 103, 4, 5]
(1 row)

select json '[1, 2, 3]' @* '[1, 2, $.map(@ + 100)[*], 4, 5][*]';
 ?column? 
----------
 1
 2
 101
 102
 103
 4
 5
(7 rows)

select json '[1, 2, 3]' @* '[(1, (2, $.map(@ + 100)[*])), (4, 5)]';
          ?column?           
-----------------------------
 [1, 2, 101, 102, 103, 4, 5]
(1 row)

select json '[1, 2, 3]' @* '[[1, 2], [$.map(@ + 100)[*], 4], 5, [(1,2)?(@ > 5)]]';
              ?column?               
-------------------------------------
 [[1, 2], [101, 102, 103, 4], 5, []]
(1 row)

select json '[1, 2, 3]' @* 'strict [1, 2, $.map(@.a)[*], 4, 5]';
ERROR:  SQL/JSON member not found
select json '[[1, 2], [3, 4, 5], [], [6, 7]]' @* '[$[*].map(@ + 10)[*] ? (@ > 13)]';
     ?column?     
------------------
 [14, 15, 16, 17]
(1 row)

-- extension: object constructors
select json '[1, 2, 3]' @* '{}';
 ?column? 
----------
 {}
(1 row)

select json '[1, 2, 3]' @* '{a: 2 + 3, "b": [$[*], 4, 5]}';
            ?column?            
--------------------------------
 {"a": 5, "b": [1, 2, 3, 4, 5]}
(1 row)

select json '[1, 2, 3]' @* '{a: 2 + 3, "b": [$[*], 4, 5]}.*';
    ?column?     
-----------------
 5
 [1, 2, 3, 4, 5]
(2 rows)

select json '[1, 2, 3]' @* '{a: 2 + 3, "b": [$[*], 4, 5]}[*]';
            ?column?            
--------------------------------
 {"a": 5, "b": [1, 2, 3, 4, 5]}
(1 row)

select json '[1, 2, 3]' @* '{a: 2 + 3, "b": ($[*], 4, 5)}';
ERROR:  Singleton SQL/JSON item required
select json '[1, 2, 3]' @* '{a: 2 + 3, "b": [$.map({x: @, y: @ < 3})[*], {z: "foo"}]}';
                                           ?column?                                            
-----------------------------------------------------------------------------------------------
 {"a": 5, "b": [{"x": 1, "y": true}, {"x": 2, "y": true}, {"x": 3, "y": false}, {"z": "foo"}]}
(1 row)

-- extension: object subscripting
select json '{"a": 1}' @? '$["a"]';
 ?column? 
----------
 t
(1 row)

select json '{"a": 1}' @? '$["b"]';
 ?column? 
----------
 f
(1 row)

select json '{"a": 1}' @? 'strict $["b"]';
ERROR:  SQL/JSON member not found
select json '{"a": 1}' @? '$["b", "a"]';
 ?column? 
----------
 t
(1 row)

select json '{"a": 1}' @* '$["a"]';
 ?column? 
----------
 1
(1 row)

select json '{"a": 1}' @* 'strict $["b"]';
ERROR:  SQL/JSON member not found
select json '{"a": 1}' @* 'lax $["b"]';
 ?column? 
----------
(0 rows)

select json '{"a": 1, "b": 2}' @* 'lax $["b", "c", "b", "a", 0 to 3]';
     ?column?     
------------------
 2
 2
 1
 {"a": 1, "b": 2}
(4 rows)

select json 'null' @* '{"a": 1}["a"]';
 ?column? 
----------
 1
(1 row)

select json 'null' @* '{"a": 1}["b"]';
 ?column? 
----------
(0 rows)

-- extension: outer item reference (@N)
select json '[2,4,1,5,3]' @* '$[*] ? (!exists($[*] ? (@ < @1)))';
 ?column? 
----------
 1
(1 row)

select json '[2,4,1,5,3]' @* '$.map(@ + @1[0])';
    ?column?     
-----------------
 [4, 6, 3, 7, 5]
(1 row)

-- the first @1 and @2 reference array, the second @1 -- current mapped array element
select json '[2,4,1,5,3]' @* '$.map(@ + @1[@1 - @2[2]])';
    ?column?     
-----------------
 [6, 9, 3, 8, 4]
(1 row)

select json '[[2,4,1,5,3]]' @* '$.map(@.reduce($1 + $2 + @2[0][2] + @1[3]))';
 ?column? 
----------
 [39]
(1 row)

-- extension: including subpaths into result
select json '{"a": [{"b": 1, "c": 10}, {"b": 2, "c": 20}]}' @* '$.(a[*].b)';
          ?column?           
-----------------------------
 {"a": [{"b": 1}, {"b": 2}]}
(1 row)

select json '{"a": [{"b": 1, "c": 10}, {"b": 2, "c": 20}]}' @* '$.(a[*]).b';
   ?column?    
---------------
 {"a": [1, 2]}
(1 row)

select json '{"a": [{"b": 1, "c": 10}, {"b": 2, "c": 20}]}' @* '$.a.([*].b)';
       ?column?       
----------------------
 [{"b": 1}, {"b": 2}]
(1 row)

select json '{"a": [{"b": 1, "c": 10}, {"b": 2, "c": 20}]}' @* '$.(a)[*].b';
 ?column? 
----------
 {"a": 1}
 {"a": 2}
(2 rows)

select json '{"a": [{"b": 1, "c": 10}, {"b": 2, "c": 20}]}' @* '$.a[*].(b)';
 ?column? 
----------
 {"b": 1}
 {"b": 2}
(2 rows)

select json '{"a": [{"b": 1, "c": 10}, {"b": 2, "c": 20}]}' @* '$.(a)[*].(b)';
    ?column?     
-----------------
 {"a": {"b": 1}}
 {"a": {"b": 2}}
(2 rows)

select json '{"a": [{"b": 1, "c": 10}, {"b": 2, "c": 20}]}' @* '$.(a.[0 to 1].b)';
          ?column?           
-----------------------------
 {"a": [{"b": 1}, {"b": 2}]}
(1 row)

-- extension: custom operators and type casts
select json '"aaa"' @* '$::text || "bbb"::text || $::text';
  ?column?   
-------------
 "aaabbbaaa"
(1 row)

select json '"aaa"' @* '$::text || "bbb" || $';
      ?column?       
---------------------
 "aaa\"bbb\"\"aaa\""
(1 row)

select json '[null, true, 1, "aaa",  {"a": 1}, [1, 2]]' @* '$.map(@::text || "xyz"::text)';
                             ?column?                              
-------------------------------------------------------------------
 [null, "truexyz", "1xyz", "aaaxyz", "{\"a\": 1}xyz", "[1, 2]xyz"]
(1 row)

select json '123.45' @* '$::int4';
 ?column? 
----------
 123
(1 row)

select json '123.45' @* '$::float4';
 ?column? 
----------
 123.45
(1 row)

select json '123.45' @* '$::text';
 ?column? 
----------
 "123.45"
(1 row)

select json '123.45' @* '$::text::int4';
ERROR:  invalid input syntax for integer: "123.45"
select json '123.45' @* '$::text::float4';
 ?column? 
----------
 123.45
(1 row)

select json '123.45' @* '$::text::float4::int4';
 ?column? 
----------
 123
(1 row)

select json '4000000000' @* '$::int8';
  ?column?  
------------
 4000000000
(1 row)

select json '[123.45, null, 0.67]' @* '$[*]::int4';
 ?column? 
----------
 123
 null
 1
(3 rows)

select json '[123.45, null, 0.67]' @* '$[*]::text';
 ?column? 
----------
 "123.45"
 null
 "0.67"
(3 rows)

select json '[123.45, null, 0.67, "8.9"]' @* '$[*]::text::float4::int4';
 ?column? 
----------
 123
 null
 1
 9
(4 rows)

select json '[123.45, 0.67]' @* '$[*]::int4 > $[0]::int4';
 ?column? 
----------
 false
(1 row)

select json '[123.45, null, 0.67]' @* '$[*]::int4 > $[0]::int4';
 ?column? 
----------
 null
(1 row)

select json '[123.45, null, 0.67]' @* '$[*]::int4 > $[1]::int4';
 ?column? 
----------
 null
(1 row)

select json '[123.45, null, 0.67]' @* '$[*]::int4 > $[2]::int4';
 ?column? 
----------
 true
(1 row)

select json '[123.45, null, 0.67]' @* '$[0]::int4 > $[*]::int4';
 ?column? 
----------
 true
(1 row)

select json '[123.45, null, 0.67]' @* '$[*]::int4 > $[2]::text::float4';
 ?column? 
----------
 true
(1 row)

select json '[123.45, null, 0.67]' @* '$[*]::text::float4 > $[2]::int4';
 ?column? 
----------
 true
(1 row)

select json '[123.45, null, 0.67]' @* '$[*]::text::float4 > $[2]::text::float4';
 ?column? 
----------
 true
(1 row)

select json '[123.45, null, 0.67]' @* '$[*]::int4 > $[0 to 1]::int4';
 ?column? 
----------
 null
(1 row)

select json '[123.45, null, 0.67]' @* '$[*]::int4 > $[1 to 2]::int4';
 ?column? 
----------
 true
(1 row)

select json '[123.45, 100000.2, 10000.67, "1"]' @* '$[0]::int8 > $[*]::int4::int8';
 ?column? 
----------
 true
(1 row)

select json '[{"a": "b"}, {"b": [1, "2"]}]' @* '$[*] -> "a"::text';
ERROR:  Singleton SQL/JSON item required
select json '[{"a": "b"}, {"b": [1, "2"]}]' @* '$[0] -> "a"::text';
 ?column? 
----------
 "b"
(1 row)

select json '[{"a": "b"}, {"b": [1, "2"]}]' @* '$[1] -> $[0].a::text';
 ?column? 
----------
 [1, "2"]
(1 row)

select json '[{"a": "b"}, {"b": [1, "2"]}]' @* '$[0] \? "a"::text';
ERROR:  operator does not exist: json ? text
HINT:  No operator matches the given name and argument type(s). You might need to add explicit type casts.
select json '[{"a": "b"}, {"b": [1, "2"]}]' @* '$[*] \? "b"::text';
ERROR:  operator does not exist: json ? text
HINT:  No operator matches the given name and argument type(s). You might need to add explicit type casts.
select json '[{"a": "b"}, {"b": [1, "2"]}]' @* '$[*] \? "c"::text';
ERROR:  operator does not exist: json ? text
HINT:  No operator matches the given name and argument type(s). You might need to add explicit type casts.
select json '[{"a": "b"}, {"b": [1, "2"]}, null, 1]' @* '$[*] ? (@ \? "a"::text)';
ERROR:  operator does not exist: json ? text
HINT:  No operator matches the given name and argument type(s). You might need to add explicit type casts.
select json '[1, "t", 0, "f", null]' @* '$[*] ? (@::int4)';
ERROR:  expected cast to boolean type
select json '[1, "t", 0, "f", null]' @* '$[*] ? (@::bool)';
 ?column? 
----------
 1
 "t"
(2 rows)

select json '[1, "t", 0, "f", null]' @* '$[*] ? (!(@::bool))';
 ?column? 
----------
 0
 "f"
(2 rows)

select json '[1, "t", 0, "f", null]' @* '$[*] ? (@::bool == false::bool)';
 ?column? 
----------
 0
 "f"
(2 rows)

select json '[1, "t", 0, "f", null]' @* '$[*] ? (@::bool || !(@::bool))';
ERROR:  operator does not exist: boolean || json
HINT:  No operator matches the given name and argument type(s). You might need to add explicit type casts.
select json '[1, 2, 3]' @* '$[*] ? (@::int4 > 1::int4)';
 ?column? 
----------
 2
 3
(2 rows)

select json '"str"' @* '$::json';
 ?column? 
----------
 "str"
(1 row)

select json '"str"' @* '$::jsonb';
 ?column? 
----------
 "str"
(1 row)

